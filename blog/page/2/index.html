
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Блог Загирова Рустама</title>
  <meta name="author" content="Загиров Рустам">

  
  <meta name="description" content="28 июля на я.субботнике был представлен новый инструмент для нагрузочного тестирования Яндекс.танк. Это внутреняя разработка яндекса, которая наконец &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.zagirov.name/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/rss/" rel="alternate" title="Блог Загирова Рустама" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-15241274-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Блог Загирова Рустама</a></h1>
  
    <h2>Около-интернетные заметки</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/rss/" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.zagirov.name" />
    <input class="search" type="text" name="q" results="0" placeholder="Поиск"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Блог</a></li>
  <li><a href="/blog/archives">Архив</a></li>
  <li><a href="/blog/categories">Метки</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/yandex-tank-load-testing/">Яндекс.танк — инструмент нагрузочного тестирования</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-02T19:30:00+04:00" pubdate data-updated="true">2012-08-02</time>
        
         | <a href="/yandex-tank-load-testing/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>28 июля на <a href="http://events.yandex.ru/events/yasubbotnik/msk-jul-2012/">я.субботнике</a> был <a href="http://events.yandex.ru/talks/268/">представлен</a> новый инструмент для нагрузочного тестирования Яндекс.танк. Это внутреняя разработка яндекса, которая наконец-то вышла в свет. Видел я этот танк ещё на YaC 2011, когда были соревнования по конфигурированию nginx.</p>

<p>Это консольный инструмент, пока не имеющий графического интерфейса, но дающий довольно полную картину в этой самой консоли.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/yandex-tank-load-testing/">Продолжение &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/yii-cookbook-2/">Yii: рецепты №2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-26T19:23:00+04:00" pubdate data-updated="true">2012-03-26</time>
        
         | <a href="/yii-cookbook-2/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Продолжаю делится интересным о Yii</p>

<h3>Шифрование данных</h3>

<p>Иногда требуется зашировать данные с возможностью последующей обратной дешифровкой.</p>

<p>В yii есть отличная обёртка для такого рода операций: <a href="http://www.yiiframework.com/doc/api/1.1/CSecurityManager#encrypt-detail">CSecurityManager::encrypt()</a> и <a href="http://www.yiiframework.com/doc/api/1.1/CSecurityManager#decrypt-detail">CSecurityManager::decrypt()</a></p>

<p>Настраиваем <a href="http://ru.wikipedia.org/wiki/Advanced_Encryption_Standard">алгоритм</a>, <a href="http://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%B6%D0%B8%D0%BC_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F">режим</a> и ключ шифрования.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/yii-cookbook-2/">Продолжение &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/yii-cookbook-1/">Yii: рецепты №1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-23T19:19:00+04:00" pubdate data-updated="true">2012-03-23</time>
        
         | <a href="/yii-cookbook-1/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Пакетирование js и css-файлов и использование зависимостей между этими пакетами.</h3>

<p>Есть замечательный инструмент для рисования графиков на js — <a href="http://www.highcharts.com/">highcharts</a>, но он использует фреймворк jQuery и сам jQuery не подключает. Соответственно, мы создаём наш пакет, где указываем js и css файлы из highcharts и прописываем зависимость от jQuery.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/yii-cookbook-1/">Продолжение &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/redirect-iframe/">Редирект при вставки сайта через Iframe</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-02T19:17:00+04:00" pubdate data-updated="true">2012-02-02</time>
        
         | <a href="/redirect-iframe/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Довольно долго бился c запрещением вставки сайта в iframe с указанием белого списка сайтов, которые могу это сделать</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">top</span> <span class="o">!=</span> <span class="nx">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">white_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;yandex.ru&#39;</span><span class="p">,</span> <span class="s1">&#39;google.com&#39;</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">isFriend</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">referrer</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">white_list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">hostname</span> <span class="o">==</span> <span class="nx">white_list</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="nx">hostname</span> <span class="o">==</span> <span class="s2">&quot;www.&quot;</span> <span class="o">+</span> <span class="nx">white_list</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">isFriend</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">isFriend</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">window</span><span class="p">.</span><span class="nx">top</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/mc-alt-mac/">Эмуляция хоткея с участием Alt в Midnight Commander</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-14T19:15:00+04:00" pubdate data-updated="true">2011-12-14</time>
        
         | <a href="/mc-alt-mac/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>После перехода на Mac OS X, не как не мог отвыкнуть от использования хоткеев с участием клавиши Alt.</p>

<p>Нашёл наконец-то способ, как съэмулировать хоткеи в сочении с Alt. Например, чтобы сделать действие по <strong>Alt+c</strong> нужно последовательно нажать <strong>Esc</strong> и <strong>c</strong>. «А ларчик просто открывался» ©.</p>

<p>Тех, кто не знаком с хоткеями в mc, предлагаю ознакомиться с <a href="https://www.midnight-commander.org/wiki/ru/doc/filePanels/hotkeys">листингом горячих сочетаний mc</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/bacula-backup/">Bacula - резервное копирование: быстро, бесплатно, без смс</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-27T19:08:00+04:00" pubdate data-updated="true">2011-11-27</time>
        
         | <a href="/bacula-backup/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Не секрет, что админы делятся на 2 типа: кто ещё не делает бэкапы и кто их уже делает. Я совсем недавно перешёл на сторону светлых админов, хочу поделиться реально работающими конфигами. Теперь седина пропала и мои волосы вновь мягкие и шелковистые =)</p>

<p>Использовать буду систему под названием <a href="http://www.bacula.org/">bacula</a>. Соответственно всё проверялось и работает под ОС GNU/Debian 6.</p>

<p>В интернете <a href="http://habrahabr.ru/blogs/sysadm/86526/">видел</a> много <a href="http://www.ignix.ru/book/freebsd/daemon/bacula">довольно</a> <a href="http://bog.pp.ru/work/bacula.html">полных</a> мануалов, где описывается конфигурация. Я описывать почти ничего не буду, просто приведу рабочие конфиги и скажу что копировать, чтобы начать бэкапить с ещё одного сервера. Можно считать статью предназначенной для тех, кто не осилил man, ну или хочет съэкономить своё время и получить работающую систему резервирования &ldquo;побыстрее&rdquo;.</p>

<p>Имеется 2 машины</p>

<ul>
<li>home.zagirov.name (1.1.1.1) &ndash; сам сервер bacula (bacula director и storage director), mysql + www</li>
<li>www.zagirov.name (2.2.2.2) &ndash; mysql + www</li>
</ul>


<p>Для mysql будем использовать собственный скрипт, который запускает <a href="http://www.percona.com/software/percona-xtrabackup/">xtrabackup</a>.</p>

<p>Устанавливаем на обоих серверах sudo (чтобы запускать бэкапилку базы от рута через sudo) и file director</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude install sudo bacula-fd openssh-server</span></code></pre></td></tr></table></div></figure>


<p>А на сервере, который будет хранить все бэкапы (home.zagirov.name &ndash; 1.1.1.1) установим ещё bacula director и storage director:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude install bacula-director-mysql bacula-sd-mysql bacula-console</span></code></pre></td></tr></table></div></figure>


<p>Выполняем на обоих серверах:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>usermod -s /bin/bash bacula</span></code></pre></td></tr></table></div></figure>


<p>Выполняем на home.zagirov.name (1.1.1.1)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>su - bacula
</span><span class='line'>mkdir -p ~/.ssh
</span><span class='line'>chmod 700 ~/.ssh
</span><span class='line'>cd ~/.ssh
</span><span class='line'>ssh-keygen -b 4096 -t rsa -f bacula -N ""
</span><span class='line'>chmod 400 ~/.ssh/*</span></code></pre></td></tr></table></div></figure>


<p>Добавляем правило для пользователя bacula запускать xtrabackup под sudo без запрашивания пароля.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo "bacula ALL=NOPASSWD: /usr/bin/xtrabackup" > /etc/sudoers.d/bacula</span></code></pre></td></tr></table></div></figure>


<p>Создаём файлы для создания бэкапов. Храниться они будут централизовано на сервере бэкапов, а запускаться на удалённых машинах будут через sudo bash -s</p>

<p><strong>/etc/bacula/scripts/xtrabackup.sh</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>DIR="/bacula/create/xtrabackup"
</span><span class='line'>if [ -d "$DIR" ]; then
</span><span class='line'>  rm -r $DIR
</span><span class='line'>fi
</span><span class='line'>mkdir -p $DIR
</span><span class='line'>
</span><span class='line'>sudo xtrabackup --defaults-file=/etc/mysql/my.cnf --datadir=/var/lib/mysql \
</span><span class='line'> --target-dir=$DIR --backup</span></code></pre></td></tr></table></div></figure>


<p><strong>/etc/bacula/scripts/xtrabackup_rm.sh</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>DIR="/bacula/create/xtrabackup"
</span><span class='line'>rm -r $DIR</span></code></pre></td></tr></table></div></figure>


<p>home.zagirov.name: <strong>/etc/bacula/bacula-dir.conf</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Director {
</span><span class='line'>  Name = home.zagirov.name-dir
</span><span class='line'>  DIRport = 9101
</span><span class='line'>  QueryFile = "/etc/bacula/scripts/query.sql"
</span><span class='line'>  WorkingDirectory = "/var/lib/bacula"
</span><span class='line'>  PidDirectory = "/var/run/bacula"
</span><span class='line'>  Maximum Concurrent Jobs = 1
</span><span class='line'>  Password = "password-director"
</span><span class='line'>  Messages = Daemon
</span><span class='line'>  DirAddress = 1.1.1.1
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Catalog {
</span><span class='line'>  Name = MyCatalog
</span><span class='line'>  dbname = "bacula"; DB Address = ""; dbuser = "bacula"; dbpassword = "password_for_db"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Console {
</span><span class='line'>  Name = home.zagirov.name-mon
</span><span class='line'>  Password = "password-console"
</span><span class='line'>  CommandACL = status, .status
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Messages {
</span><span class='line'>  Name = Daemon
</span><span class='line'>  mailcommand = "/usr/lib/bacula/bsmtp -h localhost -f \"\(Bacula\) \&lt;%r\>\" -s \"Bacula daemon message\" %r"
</span><span class='line'>  mail = root@localhost = all, !skipped            
</span><span class='line'>  console = all, !skipped, !saved
</span><span class='line'>  append = "/var/lib/bacula/log" = all, !skipped
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Messages {
</span><span class='line'>  Name = Standard
</span><span class='line'>  mailcommand = "/usr/lib/bacula/bsmtp -h localhost -f \"\(Bacula\) \&lt;%r\>\" -s \"Bacula: %t %e of %c %l\" %r"
</span><span class='line'>  operatorcommand = "/usr/lib/bacula/bsmtp -h localhost -f \"\(Bacula\) \&lt;%r\>\" -s \"Bacula: Intervention needed for %j\" %r"
</span><span class='line'>  mail = rustam@zagirov.name = all, !skipped            
</span><span class='line'>  operator = rustam@zagirov.name = mount
</span><span class='line'>  console = all, !skipped, !saved
</span><span class='line'>  append = "/var/lib/bacula/log" = all, !skipped
</span><span class='line'>  catalog = all
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Storage {
</span><span class='line'>  Name = File
</span><span class='line'>  Address = 1.1.1.1
</span><span class='line'>  SDPort = 9103
</span><span class='line'>  Password = "password-storage"
</span><span class='line'>  Device = FileStorage
</span><span class='line'>  Media Type = File
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>#Расписания
</span><span class='line'>Schedule {
</span><span class='line'>  Name = "WeeklyCycle"
</span><span class='line'>  Run = Full 1st sun at 02:05
</span><span class='line'>  Run = Differential 2nd-5th sun at 02:05
</span><span class='line'>  Run = Incremental mon-sat at 02:05
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Schedule {
</span><span class='line'>  Name = "WeeklyCycleAfterBackup"
</span><span class='line'>  Run = Full sun-sat at 02:10
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Pool {
</span><span class='line'>  Name = Default
</span><span class='line'>  Pool Type = Backup
</span><span class='line'>  Recycle = yes                       # Bacula can automatically recycle Volumes
</span><span class='line'>  AutoPrune = yes                     # Prune expired volumes
</span><span class='line'>  Volume Retention = 365 days         # one year
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Pool {
</span><span class='line'>  Name = File
</span><span class='line'>  Pool Type = Backup
</span><span class='line'>  Recycle = yes                       # Bacula can automatically recycle Volumes
</span><span class='line'>  AutoPrune = yes                     # Prune expired volumes
</span><span class='line'>  Volume Retention = 365 days         # one year
</span><span class='line'>  Maximum Volume Jobs = 1
</span><span class='line'>  Maximum Volume Bytes = 10G          # Limit Volume size to something reasonable
</span><span class='line'>  Maximum Volumes = 100               # Limit number of Volumes in Pool
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># Scratch pool definition
</span><span class='line'>Pool {
</span><span class='line'>  Name = Scratch
</span><span class='line'>  Pool Type = Backup
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>@/etc/bacula/client_home.zagirov.name.conf
</span><span class='line'>@/etc/bacula/client_www.zagirov.name.conf</span></code></pre></td></tr></table></div></figure>


<p>home.zagirov.name: <strong>/etc/bacula/client_home.zagirov.name.conf</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>### backup for home.zagirov.name
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Client {
</span><span class='line'>  Name = home.zagirov.name-fd
</span><span class='line'>  Address = 1.1.1.1
</span><span class='line'>  FDPort = 9102
</span><span class='line'>  Catalog = MyCatalog
</span><span class='line'>  Password = "password-fd-home.zagirov.name"
</span><span class='line'>  File Retention = 30 days            # 30 days
</span><span class='line'>  Job Retention = 6 months            # six months
</span><span class='line'>  AutoPrune = yes                     # Prune expired Jobs/Files
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>JobDefs {
</span><span class='line'>  Name = "DefaultJob"
</span><span class='line'>  Type = Backup
</span><span class='line'>  Level = Incremental
</span><span class='line'>  Client = home.zagirov.name-fd
</span><span class='line'>  Schedule = "WeeklyCycle"
</span><span class='line'>  Storage = File
</span><span class='line'>  Messages = Standard
</span><span class='line'>  Pool = File
</span><span class='line'>  Priority = 10
</span><span class='line'>  Write Bootstrap = "/var/lib/bacula/%c.bsr"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Job {
</span><span class='line'>  Name = "RestoreFiles"
</span><span class='line'>  Type = Restore
</span><span class='line'>  Client=home.zagirov.name-fd
</span><span class='line'>  FileSet="home.zagirov.name-www"
</span><span class='line'>  Storage = File
</span><span class='line'>  Pool = Default
</span><span class='line'>  Messages = Standard
</span><span class='line'>  Where = /bacula/restore/
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Job {
</span><span class='line'>  Name = "BackupCatalog"
</span><span class='line'>  JobDefs = "DefaultJob"
</span><span class='line'>  Level = Full
</span><span class='line'>  FileSet="Catalog"
</span><span class='line'>  Schedule = "WeeklyCycleAfterBackup"
</span><span class='line'>  RunBeforeJob = "/etc/bacula/scripts/make_catalog_backup.pl MyCatalog"
</span><span class='line'>  RunAfterJob  = "/etc/bacula/scripts/delete_catalog_backup"
</span><span class='line'>  Write Bootstrap = "/var/lib/bacula/%n.bsr"
</span><span class='line'>  Priority = 11
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>FileSet {
</span><span class='line'>  Name = "Catalog"
</span><span class='line'>  Include {
</span><span class='line'>    Options {
</span><span class='line'>      signature = MD5
</span><span class='line'>    }
</span><span class='line'>    File = "/var/lib/bacula/bacula.sql"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Job {
</span><span class='line'>  Name = "home.zagirov.name-www"
</span><span class='line'>  JobDefs = "DefaultJob"
</span><span class='line'>  FileSet = "home.zagirov.name-www"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>FileSet {
</span><span class='line'>  Name = "home.zagirov.name-www"
</span><span class='line'>  Include {
</span><span class='line'>    Options {
</span><span class='line'>      signature = MD5
</span><span class='line'>    }
</span><span class='line'>    File = /var/www
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Job {
</span><span class='line'>  Name = "home.zagirov.name-MySQL"
</span><span class='line'>  JobDefs = "DefaultJob"
</span><span class='line'>  Level = Full
</span><span class='line'>  FileSet="home.zagirov.name-MySQL"
</span><span class='line'>  Schedule = "WeeklyCycle"
</span><span class='line'>  RunBeforeJob = "/etc/bacula/scripts/xtrabackup.sh"
</span><span class='line'>  RunAfterJob  = "/etc/bacula/scripts/xtrabackup_rm.sh"
</span><span class='line'>  Write Bootstrap = "/var/lib/bacula/%n.bsr"
</span><span class='line'>  Priority = 11                   # run after main backup
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>FileSet {
</span><span class='line'>  Name = "home.zagirov.name-MySQL"
</span><span class='line'>  Include {
</span><span class='line'>    Options {
</span><span class='line'>      signature = MD5
</span><span class='line'>    }
</span><span class='line'>    File = "/bacula/create/xtrabackup"
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>home.zagirov.name: <strong>/etc/bacula/client_www.zagirov.name.conf</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>### backup from www.zagirov.name
</span><span class='line'>
</span><span class='line'>Client {
</span><span class='line'>  Name = www.zagirov.name-fd
</span><span class='line'>  Address = 2.2.2.2
</span><span class='line'>  FDPort = 9102
</span><span class='line'>  Catalog = MyCatalog
</span><span class='line'>  Password = "password-fd-www.zagirov.name"
</span><span class='line'>  File Retention = 30 days            # 30 days
</span><span class='line'>  Job Retention = 6 months            # six months
</span><span class='line'>  AutoPrune = yes                     # Prune expired Jobs/Files
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>JobDefs {
</span><span class='line'>  Name = "DefaultJob-www.zagirov.name"
</span><span class='line'>  Type = Backup
</span><span class='line'>  Level = Incremental
</span><span class='line'>  Client = www.zagirov.name-fd
</span><span class='line'>  Schedule = "WeeklyCycle"
</span><span class='line'>  Storage = File
</span><span class='line'>  Messages = Standard
</span><span class='line'>  Pool = File
</span><span class='line'>  Priority = 10
</span><span class='line'>  Write Bootstrap = "/var/lib/bacula/%c.bsr"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Job {
</span><span class='line'>  Name = "Restore-www.zagirov.name"
</span><span class='line'>  Type = Restore
</span><span class='line'>  Client=www.zagirov.name-fd
</span><span class='line'>  FileSet="www.zagirov.name"
</span><span class='line'>  Storage = File
</span><span class='line'>  Pool = Default
</span><span class='line'>  Messages = Standard
</span><span class='line'>  Where = /bacula/restore/
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Job {
</span><span class='line'>  Name = "www.zagirov.name-www"
</span><span class='line'>  JobDefs = "DefaultJob-www.zagirov.name"
</span><span class='line'>  FileSet = "www.zagirov.name-www"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>FileSet {
</span><span class='line'>  Name = "www.zagirov.name-www"
</span><span class='line'>  Include {
</span><span class='line'>    Options {
</span><span class='line'>      signature = MD5
</span><span class='line'>    }
</span><span class='line'>    File = /var/www/www.zagirov.name/www
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Job {
</span><span class='line'>  Name = "www.zagirov.name-MySQL"
</span><span class='line'>  JobDefs = "DefaultJob-www.zagirov.name"
</span><span class='line'>  Level = Full
</span><span class='line'>  FileSet="www.zagirov.name-MySQL"
</span><span class='line'>  Schedule = "WeeklyCycle"
</span><span class='line'>  RunBeforeJob = "ssh -i /var/lib/bacula/.ssh/bacula bacula-www.zagirov.name 'sudo bash -s' &lt;/etc/bacula/scripts/xtrabackup.sh"
</span><span class='line'>  RunAfterJob  = "ssh -i /var/lib/bacula/.ssh/bacula bacula-www.zagirov.name 'sudo bash -s' &lt; /etc/bacula/scripts/xtrabackup_rm.sh"
</span><span class='line'>  Write Bootstrap = "/var/lib/bacula/%n.bsr"
</span><span class='line'>  Priority = 11
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>FileSet {
</span><span class='line'>  Name = "www.zagirov.name-MySQL"
</span><span class='line'>  Include {
</span><span class='line'>    Options {
</span><span class='line'>      signature = MD5
</span><span class='line'>      compression = GZIP
</span><span class='line'>    }
</span><span class='line'>    File = "/bacula/create/xtrabackup"
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>home.zagirov.name: <strong>bacula-sd.conf</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Storage {
</span><span class='line'>  Name = home.zagirov.name-sd
</span><span class='line'>  SDPort = 9103
</span><span class='line'>  WorkingDirectory = "/var/lib/bacula"
</span><span class='line'>  Pid Directory = "/var/run/bacula"
</span><span class='line'>  Maximum Concurrent Jobs = 20
</span><span class='line'>  SDAddress = 1.1.1.1
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Director {
</span><span class='line'>  Name = home.zagirov.name-dir
</span><span class='line'>  Password = "password-storage"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Director {
</span><span class='line'>  Name = home.zagirov.name-mon
</span><span class='line'>  Password = "password-mon"
</span><span class='line'>  Monitor = yes
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Device {
</span><span class='line'>  Name = FileStorage
</span><span class='line'>  Media Type = File
</span><span class='line'>  Archive Device = /bacula/
</span><span class='line'>  LabelMedia = yes;                   # lets Bacula label unlabeled media
</span><span class='line'>  Random Access = Yes;
</span><span class='line'>  AutomaticMount = yes;               # when device opened, read it
</span><span class='line'>  RemovableMedia = no;
</span><span class='line'>  AlwaysOpen = no;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Messages {
</span><span class='line'>  Name = Standard
</span><span class='line'>  director = home.zagirov.name-dir = all
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>home.zagirov.name: <strong>/etc/bacula/bacula-fd.conf</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Director {
</span><span class='line'>  Name = home.zagirov.name-dir
</span><span class='line'>  Password = "password-fd-home.zagirov.name"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Director {
</span><span class='line'>  Name = home.zagirov.name-mon
</span><span class='line'>  Password = "password-mon-fd-home.zagirov.name"
</span><span class='line'>  Monitor = yes
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>FileDaemon {
</span><span class='line'>  Name = home.zagirov.name-fd
</span><span class='line'>  FDport = 9102
</span><span class='line'>  WorkingDirectory = /var/lib/bacula
</span><span class='line'>  Pid Directory = /var/run/bacula
</span><span class='line'>  Maximum Concurrent Jobs = 20
</span><span class='line'>  FDAddress = 1.1.1.1
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Messages {
</span><span class='line'>  Name = Standard
</span><span class='line'>  director = home.zagirov.name-dir = all, !skipped, !restored
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>home.zagirov.name: <strong>/etc/bacula/bconsole.conf</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Director {
</span><span class='line'>  Name = localhost-dir
</span><span class='line'>  DIRport = 9101
</span><span class='line'>  address = 1.1.1.1
</span><span class='line'>  Password = "password-director"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>А на удалённом настраиваем только fd</p>

<p>www.zagirov.name: <strong>/etc/bacula/bacula-fd.conf</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Director {
</span><span class='line'>  Name = home.zagirov.name-dir
</span><span class='line'>  Password = "password-fd-www.zagirov.name"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Director {
</span><span class='line'>  Name = stamm-server-mon
</span><span class='line'>  Password = "password-mon-fd-www.zagirov.name"
</span><span class='line'>  Monitor = yes
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>FileDaemon {
</span><span class='line'>  Name = www.zagirov-name-fd
</span><span class='line'>  FDport = 9102
</span><span class='line'>  WorkingDirectory = /var/lib/bacula
</span><span class='line'>  Pid Directory = /var/run/bacula
</span><span class='line'>  Maximum Concurrent Jobs = 20
</span><span class='line'>  FDAddress = 109.234.152.187
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Messages {
</span><span class='line'>  Name = Standard
</span><span class='line'>  director = home.zagirov.name-dir = all, !skipped, !restored
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Внимание!</p>

<p>Не забываем поменять пароли на свои!</p>

<p>Запускаем в консоле bconsole</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>*label
</span><span class='line'>Automatically selected Storage: File
</span><span class='line'>Enter new Volume name: backup
</span><span class='line'>Defined Pools:
</span><span class='line'>     1: Default
</span><span class='line'>     2: File
</span><span class='line'>     3: Scratch
</span><span class='line'>Select the Pool (1-3): 2
</span><span class='line'>Connecting to Storage daemon File at 95.31.29.182:9103 ...
</span><span class='line'>Sending label command for Volume "backup" Slot 0 ...
</span><span class='line'>3000 OK label. VolBytes=210 DVD=0 Volume="backup" Device="FileStorage" (/bacula/)
</span><span class='line'>Catalog record for Volume "backup", Slot 0  successfully created.
</span><span class='line'>Requesting to mount FileStorage ...
</span><span class='line'>3906 File device "FileStorage" (/bacula/) is always mounted.</span></code></pre></td></tr></table></div></figure>


<p>Восстановление происходит тоже через команду bconsole. Например, мы захотели восстановить файлы веб-сайта с www.zagirov.name на home.zagirov.name:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>*restore
</span><span class='line'>Automatically selected Catalog: MyCatalog
</span><span class='line'>Using Catalog "MyCatalog"
</span><span class='line'>
</span><span class='line'>First you select one or more JobIds that contain files
</span><span class='line'>to be restored. You will be presented several methods
</span><span class='line'>of specifying the JobIds. Then you will be allowed to
</span><span class='line'>select which files from those JobIds are to be restored.
</span><span class='line'>
</span><span class='line'>To select the JobIds, you have the following choices:
</span><span class='line'>     1: List last 20 Jobs run
</span><span class='line'>     2: List Jobs where a given File is saved
</span><span class='line'>     3: Enter list of comma separated JobIds to select
</span><span class='line'>     4: Enter SQL list command
</span><span class='line'>     5: Select the most recent backup for a client
</span><span class='line'>     6: Select backup for a client before a specified time
</span><span class='line'>     7: Enter a list of files to restore
</span><span class='line'>     8: Enter a list of files to restore before a specified time
</span><span class='line'>     9: Find the JobIds of the most recent backup for a client
</span><span class='line'>    10: Find the JobIds for a backup for a client before a specified time
</span><span class='line'>    11: Enter a list of directories to restore for found JobIds
</span><span class='line'>    12: Select full restore to a specified Job date
</span><span class='line'>    13: Cancel
</span><span class='line'>Select item:  (1-13): 5
</span><span class='line'>Defined Clients:
</span><span class='line'>     1: home.zagirov.name-fd
</span><span class='line'>     2: www.zagirov.name-fd
</span><span class='line'>Select the Client (1-2): 2
</span><span class='line'>The defined FileSet resources are:
</span><span class='line'>     1: www.zagirov.name
</span><span class='line'>     2: www.zagirov.name-MySQL
</span><span class='line'>Select FileSet resource (1-2): 1
</span><span class='line'>+-------+-------+----------+------------+---------------------+------------+
</span><span class='line'>| JobId | Level | JobFiles | JobBytes   | StartTime           | VolumeName |
</span><span class='line'>+-------+-------+----------+------------+---------------------+------------+
</span><span class='line'>|    66 | F     |    3,327 | 32,960,325 | 2011-11-19 03:47:28 | Backup     |
</span><span class='line'>|   138 | D     |        7 |  5,973,688 | 2011-11-27 02:08:41 | Backup     |
</span><span class='line'>+-------+-------+----------+------------+---------------------+------------+
</span><span class='line'>You have selected the following JobIds: 66,138
</span><span class='line'>
</span><span class='line'>Building directory tree for JobId(s) 66,138 ...  ++++++++++++++++++++++++++++++++++++++++++++
</span><span class='line'>2,959 files inserted into the tree.
</span><span class='line'>
</span><span class='line'>You are now entering file selection mode where you add (mark) and
</span><span class='line'>remove (unmark) files to be restored. No files are initially added, unless
</span><span class='line'>you used the "all" keyword on the command line.
</span><span class='line'>Enter "done" to leave this mode.
</span><span class='line'>
</span><span class='line'>cwd is: /
</span><span class='line'>$ add *
</span><span class='line'>3,327 files marked.
</span><span class='line'>$ done
</span><span class='line'>Bootstrap records written to /var/lib/bacula/home.zagirov.name-dir.restore.1.bsr
</span><span class='line'>
</span><span class='line'>The job will require the following
</span><span class='line'>   Volume(s)                 Storage(s)                SD Device(s)
</span><span class='line'>===========================================================================
</span><span class='line'>   
</span><span class='line'>    Backup                    File                      FileStorage              
</span><span class='line'>
</span><span class='line'>Volumes marked with "*" are online.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>3,327 files selected to be restored.
</span><span class='line'>
</span><span class='line'>The defined Restore Job resources are:
</span><span class='line'>     1: home.zagirov.name-restore
</span><span class='line'>     2: www.zagirov.name-restore
</span><span class='line'>Select Restore Job (1-2): 1
</span><span class='line'>Run Restore job
</span><span class='line'>JobName:         home.zagirov.name-restore
</span><span class='line'>Bootstrap:       /var/lib/bacula/home.zagirov.name-dir.restore.1.bsr
</span><span class='line'>Where:           /bacula/restore/
</span><span class='line'>Replace:         always
</span><span class='line'>FileSet:         home.zagirov.name-105
</span><span class='line'>Backup Client:   www.zagirov.name-fd
</span><span class='line'>Restore Client:  www.zagirov.name-fd
</span><span class='line'>Storage:         File
</span><span class='line'>When:            2011-11-27 02:56:27
</span><span class='line'>Catalog:         MyCatalog
</span><span class='line'>Priority:        10
</span><span class='line'>Plugin Options:  *None*
</span><span class='line'>OK to run? (yes/mod/no): y
</span><span class='line'>Job queued. JobId=143
</span><span class='line'>You have messages.</span></code></pre></td></tr></table></div></figure>


<p>Для добавления нового сервера необходимо добавить в конфиг bacula director инклуд нового файла, который будет содержать следующие директивы:</p>

<ul>
<li><strong>Client</strong>, в который прописываем имя, ip и пароль</li>
<li><strong>JobDefs</strong> &ndash; исходный джоб, от которого все будут наследоваться</li>
<li><strong>Job</strong> восстановления впринципе не обязательно прописывать, но это удобно, когда нужно восстанавливать прямо на нужный сервер</li>
<li><strong>Job</strong> и <strong>FileSet</strong> &ndash; собственно сам джоб и список файлов для этого джоба
Думаю, теперь bacula кажется не такой уж и страшной как в начале?</li>
</ul>


<p>Ссылки:</p>

<ul>
<li><a href="http://habrahabr.ru/blogs/sysadm/86526/">http://habrahabr.ru/blogs/sysadm/86526/</a></li>
<li><a href="http://bog.pp.ru/work/bacula.html">http://bog.pp.ru/work/bacula.html</a></li>
<li><a href="http://www.ignix.ru/book/freebsd/daemon/bacula">http://www.ignix.ru/book/freebsd/daemon/bacula</a></li>
<li><a href="http://habrahabr.ru/blogs/sysadm/111555/">http://habrahabr.ru/blogs/sysadm/111555/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/nginx-config/">Nginx: общие принципы конфигурации</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-30T18:59:00+04:00" pubdate data-updated="true">2011-10-30</time>
        
         | <a href="/nginx-config/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>На днях посмотрел <a href="http://video.yandex.ru/users/ibondarets/view/1/">видео с участием Игоря Сысоева</a> &ndash; отца русского nginx =)</p>

<p>В выступлении Игорь говорит не о мастабировании в привычном для всех понимании (высокая нагрузка), а в плане рекомендаций к написанию конфигурации для nginx, чтобы при росте конфигурации не было проблем с его редактированием.</p>

<h2>Виды location:</h2>

<ol>
<li>Описанные простыми строками (статические)</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location /dir/ {} - обычный префиксный location
</span><span class='line'>location = /dir/ {} - точное совпадение по запросу
</span><span class='line'>location ^~ /dir/ {} - префиксный location, но после него не идёт проверка по location на регулярных выражениях</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Описанные регулярными выражениями</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location ~ /dir/ {} - с учётом регистра
</span><span class='line'>location ~* /dir/ {} - без учёта регистра</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Именнованные location</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location @php {}</span></code></pre></td></tr></table></div></figure>


<p>Расположение статических location не играет роли.</p>

<p>Location&#8217;ы, написанные с помощью регулярных выражений, выполянются в порядке написания.</p>

<p>По возможности используйте статические location&#8217;ы. Например, вместо</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location ~ .(css|js|jpe?g|png)$ {}</span></code></pre></td></tr></table></div></figure>


<p>выносить все статические файлы в определённый каталог</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location /static/ {}</span></code></pre></td></tr></table></div></figure>


<p>Заворачивание location на регулярном выражении в статический location</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location ~* ^/i/(.)(.-\.gif)(
</span><span class='line'>  alias /images/$1$1$2
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location /i/ {
</span><span class='line'>  location ~* ^/i/(.)(.-\.gif)$ {
</span><span class='line'>    alias /images/$1$1$2
</span><span class='line'>  }
</span><span class='line'>  return 404
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Понимание директив root и alias:</p>

<p>В общем смысле, root &ndash; добавляем в запрос путь в качестве префикса, а alias &ndash; заменяет location на указанный в директиве alias</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location /dir/ {
</span><span class='line'>    root /path/to/data;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dir/a/image.gif
</span><span class='line'>/path/to/data/dir/a/image.gif</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location /dir/ {
</span><span class='line'>     alias /path/to/data/;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dir/a/image.gif
</span><span class='line'>/path/to/data/a/image.gif</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location ~ ^/dir/ {
</span><span class='line'>  root /path/to/$subdomain;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dir/a/image.gif
</span><span class='line'>/path/to/shop/dir/a/image.gif</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location ~ ^/dir/.+/(.)(.*)$ {
</span><span class='line'>    alias /path/to/data/$1/$1$2;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dir/a/image.gif
</span><span class='line'>/path/to/data/i/image.gif</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location ~ ^/dir/ {
</span><span class='line'>    alias /path/to/data/0.gif
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dir/a/image.gif
</span><span class='line'>/path/to/data/0.gif</span></code></pre></td></tr></table></div></figure>


<p>Обратите внимание на конечных слэш в proxy_pass</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location /dir/ {
</span><span class='line'>  proxy_pass http://back
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dir/a/image.gif
</span><span class='line'>/dir/a/image.gif</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location /dir/ {
</span><span class='line'>    proxy_pass http://back/
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dir/a/image.gif
</span><span class='line'>    /a/image.gif</span></code></pre></td></tr></table></div></figure>


<p>Большинство директив носит декларативный характер, а это значит нет разницы, где их определять.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>    location / {}
</span><span class='line'>    location /images/ {}
</span><span class='line'>    
</span><span class='line'>    root /path/;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Не рекомендуется использовать if. В примере сработает только последний if. Игорь рекомендует использовать if в связке с return.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location / {
</span><span class='line'>
</span><span class='line'>  if (1) {
</span><span class='line'>    gzip off;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  if (1) {
</span><span class='line'>    keepalive off;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Распространённые ошибки:</h2>

<p>В этом примере break вообще не нужен, а expires можно вынести в location</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location ~* \.(gif|jpe?g|png)$ {
</span><span class='line'>  root /data;
</span><span class='line'>  if (-e $request_filename) {
</span><span class='line'>     expires 1y;
</span><span class='line'>     break;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Break тут не нужен.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location ~* \.(gif|jpe?g|png)$ {
</span><span class='line'>   root /data;
</span><span class='line'>   break;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Такое возникает у переходящих с apache. Тут нужно заменить всё на статические location.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>location / {
</span><span class='line'>  if ($uri ~ ^/login.php$) { }
</span><span class='line'>
</span><span class='line'>  if ($uri ~ ^/image.php$) { }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/yii-console-completion/">Yii: автодополнение в консоли</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-23T18:57:00+04:00" pubdate data-updated="true">2011-10-23</time>
        
         | <a href="/yii-console-completion/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Очень не хватало автодополнения комманд при вызове консольных комманд yii, чувствовал какую-то неполноценность yii в bash.</p>

<p>На просторах интернета была найдена статья, позволяющая реализовать автодополнение с помощью родной unix-утилиты bash_completion.</p>

<p>Если у вас проект находиться под управлением git, то просто добавляем сабмодуль:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git submodule add git://github.com/Stamm/yii-console-completion protected/extensions/complete/
</span></code></pre></td></tr></table></div></figure>


<p>Или создайте файл LCompleteCommand.php в protected/extensions/complete/</p>

<p>Теперь подключаем класс в конфигурационном файле для консольного приложения (обычно это console.php):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="s1">&#39;commandMap&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;complete&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ext.complete.LCompleteCommand&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="c1">//&#39;bashFile&#39; =&gt; &#39;/etc/bash_completion.d/yii_applications&#39; //Defaults to &lt;/etc/bash_completion.d/yii_applications&gt;. May be changed if needed</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>


<p>Пути до директории bash-completion могут различаться в зависимости от системы. Для Debian и Ubuntu можно оставить стандартный путь. В Mac OS X bash-completion был установлен с помощью homebrew, так что путь нужно сменить на /usr/local/etc/bash_completion.d/yii_applications</p>

<p>Теперь выполняем комманду для создания bash-completion файла от root:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo ./yiic <span class="nb">complete </span>install
</span></code></pre></td></tr></table></div></figure>


<p>Теперь при создании новой сессии в bash будет работать автодополнение для yiic:</p>

<ol>
<li>Для приложения — набор возможных команд</li>
<li>Для команды — набор возможных действий (actions) и именованых параметров действия по умолчанию</li>
<li>Для действия — подсказки по ее именованым параметрам</li>
</ol>


<p>Источник: <a href="http://habr-sandbox.livejournal.com/230319.html">http://habr-sandbox.livejournal.com/230319.html</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/phpstorm-redmine-changelist-workflow/">Организация рабочего потока: Phpstorm, Redmine, Changelists</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-23T18:53:00+04:00" pubdate data-updated="true">2011-10-23</time>
        
         | <a href="/phpstorm-redmine-changelist-workflow/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Сегодня я покажу как у меня получается сделать работу удобной с использованием Phpstorm, Redmine, Teamcity.</p>

<ul>
<li>Есть задача в redmine.</li>
<li>Я начинаю её выполнять.</li>
<li>Всё проверяю локально и коммичу в репозиторий.</li>
<li>Выливаю изменения на тестовый сервер.</li>
</ul>


<p>Есть несколько ньюансов. Бывают задачи очень объёмные и/или не очень срочные, которые я делаю в перерывах между задачами с более высокими приоритетами. Или спокойно делаю задачу, но прибегает менеджер с огромными глазами и криками, что сайт выдаёт ошибку, и нужно сделать быстрый hotfix.</p>

<p>В этом случае очень помогают changelist в PhpStorm.</p>

<p>Смысл changelist&#8217;а заключается в логическом разделении группы файлов для коммита. Т.е. файлы &ldquo;прикрепляются&rdquo; к определённому changelist&#8217;у. И при коммите мы выбираем нужный changelist и коммитим только файлы из этого changelist&#8217;а. Changelist есть всегда, по-умолчанию название default.</p>

<p>Настраиваем Redmine:</p>

<p>Нужно включить в параметрах redmine пункт <strong>Enable REST web service</strong></p>

<p><img src="/images/phpstorm-redmine-changelist-workflow/phpstorm-changelist-1.png" alt="phpstorm-changelist" /></p>

<p>Добавляем новый Task server в PhpStorm. Api token можно найти в личном разделе в redmine.</p>

<p><img src="/images/phpstorm-redmine-changelist-workflow/phpstorm-changelist-3.png" alt="phpstorm-changelist" /></p>

<p>И добавляем парсинг номера задачи из описания коммита для отображения её как ссылки на задачу в redmine.</p>

<p>Project Settings → Version Control → Issue Navigation</p>

<p>Вводим паттерн регулярного выражения <strong>#(\d+)</strong> и генерируемую ссылку: **<a href="http://redmine.company.com/issues/$1**">http://redmine.company.com/issues/$1**</a></p>

<p><img src="/images/phpstorm-redmine-changelist-workflow/phpstorm-changelist-4.png" alt="phpstorm-changelist" /></p>

<p>Теперь открываем задачу Tools → Task → Open. Тут работает автодополнение для имени задачи.</p>

<p>Если были открытые файлы, то они все скроются. Сейчас мы работаем в своём наборе открытых файлов. Если откроем changelist под названием default, то все открытые файлы вернуться в редактор. Нужно понимать, что изменения в скрытых файлах остаются (это вам не git stash), а просто скрываются из вида.</p>

<p>Мы можем создать множество changelist&#8217;ов. Они не обязательно создаются из задачи, можно создать свой changelist. Я, например, создаю changelist NO для временных файлов, файлов своих настроек, декларативные скрипты для работы автодополнения, которые мне не нужно включать в коммит.</p>

<p>Теперь при коммите будут выбраны только файлы, которые находяться в выбранном changelist&#8217;е.</p>

<p>Откройте в разделе changes (alt+9 или ⌘+9) вкладку Local. Тут показаны изменённые файлы, сгруппированные по changelist&#8217;ам. Здесь файлы можно перемещать между changelist&#8217;ами.</p>

<p><img src="/images/phpstorm-redmine-changelist-workflow/phpstorm-changelist-8.1.png" alt="phpstorm-changelist" /></p>

<p>Кликнув правой кнопкой по changelist, вы можете изменить его комментарий. Этот комментарий потом автоматически вставиться в описание коммита.</p>

<p>Для запуска сборки проекта в TeamCity из PhpStorm нужно поставить соответсвующий плагин.</p>

<p>Получилась вот такая схема работы. Ребята из JetBrains очень крутые: развивают продукт очень стремительно, вводять очень удобные фишки. Кто ещё не пробывал PhpStorm &ndash; обязательно попробуйте. А на него перешёл с Netbeans и нисколько не жалею.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/yii-cache-cactivedataprovider/">Yii: используем кэш в CActiveDataProvider</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-17T18:48:00+04:00" pubdate data-updated="true">2011-10-17</time>
        
         | <a href="/yii-cache-cactivedataprovider/#disqus_thread">Комментарии</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Репост моей заметки из wiki: <a href="http://www.yiiframework.com/wiki/233/using-cache-in-cactivedataprovider/.">http://www.yiiframework.com/wiki/233/using-cache-in-cactivedataprovider/.</a></p>

<p>Первый параметр в конструкторе <a href="http://www.yiiframework.com/doc/api/1.1/CActiveDataProvider/">CActiveDataProvider</a> может быть строковым значением с названием модели или экземпляр класса модели.</p>

<p>Поэтому можно использовать <a href="http://www.yiiframework.com/doc/api/1.1/CActiveRecord#cache-detail">CActiveRecord::cache()</a> для кэширования, но нужно установить значение 3 у третьего параметра, потому что мы должны закэшировать 2 запроса: получение количества записей и само получение записей.</p>

<p>Не забудьте использовать зависимости для принудительного протухания кэша.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$dependecy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CDbCacheDependency</span><span class="p">(</span><span class="s1">&#39;SELECT MAX(update_time) FROM {{post}}&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">CActiveDataProvider</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span><span class="nv">$duration</span><span class="p">,</span> <span class="nv">$dependecy</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="k">array</span> <span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;criteria&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;status = 1&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;order&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;DESC create_time&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="s1">&#39;pagination&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;pageSize&#39;</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Старее</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Новее &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Недавнее</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/capistrano3-unicorn/">Unicorn в Capistrano 3</a>
      </li>
    
      <li class="post">
        <a href="/mac-environments/">Софт на Mac OS X</a>
      </li>
    
      <li class="post">
        <a href="/thinking-sphinx-mac-os-x/">Бага Thinking-sphinx в Mac OS X</a>
      </li>
    
      <li class="post">
        <a href="/macos-update-mysql2-mysql-5-dot-6/">Обновление Gem Mysql2 на MacOS X при обновлении MySQL до 5.6</a>
      </li>
    
      <li class="post">
        <a href="/how-to-install-ruby-2-dot-0-0-p0/">Как установить Ruby 2.0.0-p0</a>
      </li>
    
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2010-2013 — Загиров Рустам. 
  <span class="credit"><a href="http://octopress.org">Octopress</a> помогает в создании блога</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zagirov';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter1233706 = new Ya.Metrika({id:1233706,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="//mc.yandex.ru/watch/1233706" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

</body>
</html>
