
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Блог Загирова Рустама</title>
  <meta name="author" content="Загиров Рустам">

  
  <meta name="description" content="Продолжаем осваивать плагинописание для браузеров на основе chromium и ,соответственно, для google chrome. Текущая тема: научиться использовать local &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://stamm.github.io/blog/page/4">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Блог Загирова Рустама" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Блог Загирова Рустама</a></h1>
  
    <h2>Около-интернетные заметки</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:stamm.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Блог</a></li>
  <li><a href="/blog/archives">Архив</a></li>
  <li><a href="/blog/categories">Метки</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/google-chrome-extensions-local-database-storage/">Расширение для Google Chrome: Local Database Storage</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-02T16:12:00+03:00" pubdate data-updated="true">2011-01-02</time>
        
         | <a href="/google-chrome-extensions-local-database-storage/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Продолжаем осваивать плагинописание для браузеров на основе chromium и ,соответственно, для google chrome. Текущая тема: научиться использовать local database storage. Local database storage &ndash; это база данных, использумая из javascript. Представляет она собой SQLite внутри. Синтаксис привычный для SQL баз. Я буду использовать базу для запоминания всех полученных цитат. Логически все действия можно разделить на 4 операции:</p>

<ol>
<li>Открытие базы и получение коннекта к ней</li>
<li>Создание таблицы</li>
<li>Запись в таблицу</li>
<li>Чтение из таблицы</li>
</ol>


<p>Открытие базы и получение коннекта</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">get_db</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">openDatabase</span><span class="p">(</span><span class="s2">&quot;quotes&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;A list of quotes.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>где quotes &ndash; название базы данных 1.0 &ndash; версия БД (не изменять) A list of quotes &ndash; комментарий 210241024 &ndash; максимальный размер базы данных в байтах</p>

<p>Создание таблицы</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">get_db</span><span class="p">().</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">tx</span><span class="p">.</span><span class="nx">executeSql</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE quotes (text TEXT, author TEXT, timestamp REAL)&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Запись в таблицу</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">get_db</span><span class="p">().</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">tx</span><span class="p">.</span><span class="nx">executeSql</span><span class="p">(</span><span class="s2">&quot;INSERT INTO quotes (text, author, timestamp) VALUES (?, ?, ?)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">text</span><span class="p">,</span> <span class="nx">author</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()]);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Чтение из таблицы</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">get_db</span><span class="p">().</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">tx</span><span class="p">.</span><span class="nx">executeSql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM quotes ORDER BY rowid DESC LIMIT 3&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">alert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">item</span><span class="p">(</span><span class="nx">i</span><span class="p">)[</span><span class="s1">&#39;text&#39;</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span> <span class="kc">null</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>rowid &ndash; &ldquo;скрытое&rdquo; поле, с типом autoinc</p>

<p><a href="https://github.com/Stamm/chrome.extension.forismatic">Исходный код на github</a></p>

<p>Ссылки по теме:</p>

<ul>
<li><a href="http://dev.w3.org/html5/webdatabase/">http://dev.w3.org/html5/webdatabase/</a></li>
<li><a href="http://www.sqlite.org/docs.html">http://www.sqlite.org/docs.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/write-extension-to-google-chrome/">Пишем расширение под Google Chrome</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-08T16:02:00+03:00" pubdate data-updated="true">2010-12-08</time>
        
         | <a href="/write-extension-to-google-chrome/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>В связи с последними тенденциями в вебе (в том числе и недавний запуск <a href="https://chrome.google.com/webstore">webstore</a>), возникла идея попрактиковаться в написании плагина под Google Chrome. Решил написать плагин, который бы показывал цитаты с сайта <a href="http://forismatic.com/">Forismatic.com</a>, после прочтения <a href="http://habrahabr.ru/blogs/personal/102076/">статьи о написании аналогичного апплета для gnome</a>.</p>

<p><a href="https://chrome.google.com/extensions/detail/aegemfnepncjfdnlphmlpmfaninhgafg">Страница установки плагина</a>.</p>

<h3>Требования:</h3>

<ul>
<li>показ уведомлений через всплывающее окошко.</li>
<li>двуязычность: русский и английский, причём язык должен подцепляться автоматически в зависимости от выставленного в браузере. Но при этом оставлять выбор на каком языке получать цитаты.</li>
<li>настройка интервала обновления</li>
</ul>


<p>Всем начинающим рекомендую сначала прочитать <a href="http://code.google.com/chrome/extensions/getstarted.html">отличный мануал от самого google</a>. В нём всё подробно описано, также есть примеры. Вообще можно увидеть исходники любого приложения: достаточно зайти в папку ~/.config/chromium/Default/Extensions (используется Chromium на Ubuntu).</p>

<p>Весь исходный код моего расширения <a href="https://github.com/Stamm/chrome.extension.forismatic">доступен на гитхабе</a>.</p>

<p>Получать цитаты будем с помощью <a href="http://ru.forismatic.com/api/">api forismatic.com</a> в формате json.</p>

<p>Вот такой GET-запрос должен получится:
<a href="http://api.forismatic.com/api/1.0/?method=getQuote&amp;format=json&amp;key=123456lang=ru">http://api.forismatic.com/api/1.0/?method=getQuote&amp;format=json&amp;key=123456lang=ru</a></p>

<p>Меняем lang на выбранный язык, а параметр key произвольно.</p>

<p>Теперь перейдём непосредственно к созданию приложения
Необходимо создать такую структуру:</p>

<ul>
<li><strong>_locales/en/messages.json</strong> #для перевода на английский язык</li>
<li><strong>_locales/ru/messages.json</strong> #для перевода на русский язык</li>
<li><strong>background.html</strong> #файл, который выполняется при запуске плагина</li>
<li><strong>functions.js</strong> #небольшая библиотечка написанных функций</li>
<li><strong>icon.png</strong> #В связи с запуском webstore рекомендую использовать иконки по-качественней</li>
<li><strong>manifest.json</strong> #файл описания плагина</li>
<li><strong>options.html</strong> #html-файл настроек</li>
</ul>


<p>Сначала создаём файлы переводы.</p>

<p><strong>_locales/en/messages.json</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "extName": {
</span><span class='line'>    "message": "Forismatic quotes"
</span><span class='line'>  },
</span><span class='line'>  "extDescr": {
</span><span class='line'>    "message": "Show quote from Forismatic.com"
</span><span class='line'>  },
</span><span class='line'>  "language": {
</span><span class='line'>    "message": "Language"
</span><span class='line'>  },
</span><span class='line'>  "refresh": {
</span><span class='line'>    "message": "Time refresh"
</span><span class='line'>  },
</span><span class='line'>  "save": {
</span><span class='line'>    "message": "Save"
</span><span class='line'>  },
</span><span class='line'>  "options": {
</span><span class='line'>    "message": "Options"
</span><span class='line'>  },
</span><span class='line'>  "options_saved": {
</span><span class='line'>    "message": "Options saved"
</span><span class='line'>  },
</span><span class='line'>  "minutes": {
</span><span class='line'>    "message": "in minutes"
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><strong>_locales/ru/messages.json</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "extName": {
</span><span class='line'>    "message": "Forismatic цицаты"
</span><span class='line'>  },
</span><span class='line'>  "extDescr": {
</span><span class='line'>    "message": "Показывает цитаты с сайта Forismatic.com"
</span><span class='line'>  },
</span><span class='line'>  "language": {
</span><span class='line'>    "message": "Язык"
</span><span class='line'>  },
</span><span class='line'>  "refresh": {
</span><span class='line'>    "message": "Время обновления"
</span><span class='line'>  },
</span><span class='line'>  "save": {
</span><span class='line'>    "message": "Сохранить"
</span><span class='line'>  },
</span><span class='line'>  "options": {
</span><span class='line'>    "message": "Опции"
</span><span class='line'>  },
</span><span class='line'>  "options_saved": {
</span><span class='line'>    "message": "Настройки сохранены"
</span><span class='line'>  },
</span><span class='line'>  "minutes": {
</span><span class='line'>    "message": "в минутах"
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Теперь можно описать расширение в манифесте</p>

<p><strong>manifest.json</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "default_locale":"en",
</span><span class='line'>  "name": "__MSG_extName__",
</span><span class='line'>  "description": "__MSG_extDescr__",
</span><span class='line'>  "version": "0.1.1",
</span><span class='line'>  "background_page": "background.html",
</span><span class='line'>  "options_page": "options.html",
</span><span class='line'>  "permissions": [
</span><span class='line'>    "notifications",
</span><span class='line'>    "http://api.forismatic.com/*"
</span><span class='line'>  ],
</span><span class='line'>  "icons": {
</span><span class='line'>    "128": "icon.png"
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Параметр <strong>default_locale</strong> определяет стандартную локаль.</p>

<p>Параметр name описывает имя расширения. Мы его задаём в зависимости от языка, используя ранее описанную переменную в файлах локализации <strong>extName</strong>, предварительно обернув её: <strong>MSG_extName</strong> Также поступим и с параметром <strong>description</strong>. Кстати, при отображении расширения на <a href="https://chrome.google.com/extensions/">https://chrome.google.com/extensions/</a> или на <a href="https://chrome.google.com/webstore">https://chrome.google.com/webstore</a> будет тоже подставляться значение в зависимости от выбранного языка.</p>

<p>В значении <strong>version</strong> указываем версию плагина (причём при заливке новых версий, она должна быть больше предыдущей, что логично). Chrome будет раз в несколько часов и при загрузке проверять обновление плагина и автоматически обновлять его.</p>

<p>Параметры <strong>background_page</strong> и <strong>options_page</strong> указывают на страницу, выполняющуюся в фоне, и страницу настроек. В параметре permissions передаем массив, в котором описываем, что может делать расширение. Мы включили доступ к уведомлениям (notifications) и доступ к сайту api (<a href="http://api.forismatic.com/*">http://api.forismatic.com/*</a>).</p>

<p>С параметром <strong>icons</strong> всё понятно.</p>

<p>Библиотека функций для javascript</p>

<p><strong>functions.js</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//"Главная" функция, которая будет показывать всплывающее окно с цитатой
</span><span class='line'>function main()
</span><span class='line'>{
</span><span class='line'>  req = new XMLHttpRequest();
</span><span class='line'>  req.onload = function () {
</span><span class='line'>    var doc = req.responseText;
</span><span class='line'>    if (doc) {
</span><span class='line'>      //Хак, позволяющий получить json как объект
</span><span class='line'>      var json = eval('(' + doc + ')');
</span><span class='line'>      author = json.quoteAuthor;
</span><span class='line'>      text = json.quoteText;
</span><span class='line'>      link = json.quoteLink;
</span><span class='line'>      //Можно создать запись в логе
</span><span class='line'>      console.log(author + ' ' + text);
</span><span class='line'>      //Показываем цитату
</span><span class='line'>      showNotification(author, text);
</span><span class='line'>    }
</span><span class='line'>  };
</span><span class='line'>  req.open("GET", "http://api.forismatic.com/api/1.0/?method=getQuote&format=json&key=" + Math.random()*1000000 + "&lang=" + localStorage['lang'], true);
</span><span class='line'>  req.send(null);
</span><span class='line'>}
</span><span class='line'>//Хелпер для показа всплывающего окна
</span><span class='line'>function showNotification(title, text)
</span><span class='line'>{
</span><span class='line'>  var notification = webkitNotifications.createNotification(
</span><span class='line'>    '',
</span><span class='line'>    title,
</span><span class='line'>    text
</span><span class='line'>  );
</span><span class='line'>  notification.show();
</span><span class='line'>  //Убираем окно через 15 секунд
</span><span class='line'>  window.setInterval(function() {
</span><span class='line'>    notification.cancel();
</span><span class='line'>  }, 15000);
</span><span class='line'>}
</span><span class='line'>//Глобальная переменная для сохранения setInterval
</span><span class='line'>var interval;
</span><span class='line'>//Функция для запуска, которая через выставленное время в настройках будет запускать функцию main. Также запускается при измении времени обновления
</span><span class='line'>function init() {
</span><span class='line'>  if ( ! localStorage['refresh'])
</span><span class='line'>    return;
</span><span class='line'>  window.clearInterval(interval)
</span><span class='line'>  interval = window.setInterval(function() {
</span><span class='line'>    main();
</span><span class='line'>  }, localStorage['refresh'] * 60000);
</span><span class='line'>  console.log(localStorage['refresh'] * 60000);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Файл, который выполняется при запуске плагина.</p>

<p><strong>background.html</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!DOCTYPE html>
</span><span class='line'>&lt;html>
</span><span class='line'>&lt;head>
</span><span class='line'>&lt;meta charset=utf-8 />
</span><span class='line'>&lt;script src="functions.js">&lt;/script>
</span><span class='line'>&lt;script>
</span><span class='line'>
</span><span class='line'>//Поставить дефолтные значения при первом запуске
</span><span class='line'>if( ! localStorage['refresh'])
</span><span class='line'>{
</span><span class='line'>  localStorage['refresh'] = 30;
</span><span class='line'>}
</span><span class='line'>if( ! localStorage['lang'])
</span><span class='line'>{
</span><span class='line'>  //Получаем язык, используемый в браузере
</span><span class='line'>  var lang = chrome.i18n.getMessage("@@ui_locale");
</span><span class='line'>  if (lang == 'ru')
</span><span class='line'>    localStorage['lang'] = "ru";
</span><span class='line'>  else
</span><span class='line'>    localStorage['lang'] = "en";
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//Добавляем listener, для приёма вызова со страницы опций, чтобы обновить время обновления цитат
</span><span class='line'>chrome.extension.onRequest.addListener(
</span><span class='line'>  function(request, sender, sendResponse) {
</span><span class='line'>    //Проверка, что данные пришли со страницы опций этого же плагина и параметр do равен update
</span><span class='line'>    if (sender.tab.url == chrome.extension.getURL(«options.html») && request.do == "update")
</span><span class='line'>   {
</span><span class='line'>     //Показываем цитату
</span><span class='line'>     main();
</span><span class='line'>      init();
</span><span class='line'>      console.log('Update refresh time from options !');
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>);
</span><span class='line'>//Показываем цитату при запуске
</span><span class='line'>main();
</span><span class='line'>
</span><span class='line'>init();
</span><span class='line'>&lt;/script>
</span><span class='line'>&lt;/head>
</span><span class='line'>&lt;/html></span></code></pre></td></tr></table></div></figure>


<p>Настройки плагина</p>

<p><strong>options.html</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!DOCTYPE html>
</span><span class='line'>&lt;html>
</span><span class='line'>&lt;meta charset=utf-8 />
</span><span class='line'>&lt;head>&lt;title>Options&lt;/title>&lt;/head>
</span><span class='line'>&lt;script src="functions.js">&lt;/script>
</span><span class='line'>&lt;script type="text/javascript">
</span><span class='line'>
</span><span class='line'>//Сохраняем опции
</span><span class='line'>function save_options()
</span><span class='line'>{
</span><span class='line'>  localStorage['lang'] = document.getElementById("lang").value;
</span><span class='line'>  localStorage['refresh'] = parseFloat(document.getElementById("refresh").value);
</span><span class='line'>
</span><span class='line'>  //Показываем пользователю, что настройки сохранены
</span><span class='line'>  var status = document.getElementById("status");
</span><span class='line'>  status.innerHTML = chrome.i18n.getMessage("options_saved");
</span><span class='line'>  setTimeout(function() {
</span><span class='line'>    status.innerHTML = "";
</span><span class='line'>  }, 1750);
</span><span class='line'>
</span><span class='line'>  //Посылаем запрос на background.html
</span><span class='line'>  chrome.extension.sendRequest({do: "update"});
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//Восстанавливаем значения из localStorage
</span><span class='line'>function restore_options()
</span><span class='line'>{
</span><span class='line'>  //Выставляем язык
</span><span class='line'>  document.getElementById("locale_refresh").innerHTML = chrome.i18n.getMessage("refresh");
</span><span class='line'>  document.getElementById("locale_minutes").innerHTML = chrome.i18n.getMessage("minutes");
</span><span class='line'>  document.getElementById("locale_language").innerHTML = chrome.i18n.getMessage("language");
</span><span class='line'>  document.getElementById("locale_save").value = chrome.i18n.getMessage("save");
</span><span class='line'>  document.title = chrome.i18n.getMessage("options");
</span><span class='line'>
</span><span class='line'>  //Выставляем значения
</span><span class='line'>  //Можно поставить:
</span><span class='line'>  //document.getElementById("lang").value = localStorage["lang"] == undefined ? 'en' : localStorage["lang"];
</span><span class='line'>  //Но в background.html уже выставлены значения по-умолчанию
</span><span class='line'>  document.getElementById("lang").value = localStorage["lang"];
</span><span class='line'>  document.getElementById("refresh").value = localStorage["refresh"];
</span><span class='line'>}
</span><span class='line'>&lt;/script>
</span><span class='line'>&lt;body onload="restore_options()">
</span><span class='line'>&lt;form action="" onsubmit="save_options();return false;">
</span><span class='line'>&lt;span id="locale_refresh">Time refresh&lt;/span>: &lt;input name="refresh" id="refresh" size="1" /> &lt;span id="locale_minutes">in minutes&lt;/span> &lt;br />
</span><span class='line'>&lt;span id="locale_language">Language&lt;/span>:
</span><span class='line'>  &lt;select name="lang" id="lang">
</span><span class='line'>    &lt;option value="ru">Русский&lt;/option>
</span><span class='line'>    &lt;option value="en">English&lt;/option>
</span><span class='line'>  &lt;/select>
</span><span class='line'>&lt;br />
</span><span class='line'>&lt;input type="submit" value="Save" id="locale_save"/>
</span><span class='line'>&lt;/form>
</span><span class='line'>&lt;div id="status">&lt;/div>
</span><span class='line'>&lt;/body>
</span><span class='line'>&lt;/html></span></code></pre></td></tr></table></div></figure>


<p>Cкрипт, который помогает упаковывать расширение:</p>

<p><strong>zip.sh</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>zip -r chrome-ext-forismatic.zip ./* -x ".git" -x "zip.sh"</span></code></pre></td></tr></table></div></figure>


<p>Теперь можно запустить плагин в браузере: Tools » Расширения » Загрузить распакованное расширение Должно появиться всплывающее окно с цитатой. Можно зайти в настройки, сменить язык. При сохранении, должная появиться цитата на другом языке.</p>

<p>После создания и тестирования необходимо выложить плагин. Заходим на страницу: <a href="https://chrome.google.com/extensions/developer/dashboard?hl=ru,">https://chrome.google.com/extensions/developer/dashboard?hl=ru,</a> загружаем архив с плагином, указываем нужные параметры (скриншоты, разделы) и нажимаем Publish changes и наше приложение уже на странице плагинов и на webstore.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/configure-netbeans-to-yii-with-xdebug-unit-tests/">Настройка Netbeans для Yii с поддержкой Xdebug, тестов Phpunit и Selenium</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-24T14:05:00+04:00" pubdate data-updated="true">2010-10-24</time>
        
         | <a href="/configure-netbeans-to-yii-with-xdebug-unit-tests/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>После прочтения книги <a href="http://www.amazon.com/dp/1847199585?tag=gii20f-20&amp;camp=0&amp;creative=0&amp;linkCode=as1&amp;creativeASIN=1847199585&amp;adid=0BHF2HS6FNS82M85KJQT">Agile Web Application Development with Yii 1.1 and PHP5</a> захотелось рассказать о настройке NetBeans для работы с yii, включая поддержку unit-тестов + тесты через selenium.</p>

<p>Selenium позволяет проводить тесты, почти полностью эмулируя действия через браузер: кликать по ссылкам, вводить текст.</p>

<p>Это очень мощно!
Имеются:
&ndash; Сервер (ip: 192.168.0.3) Debian или другой linux-сервер <a href="/debian-4-configure-web-server-nginx-apache-mysql-postgresql/">с настроенным nginx, php5-fpm, xdebug</a>
&ndash; Компьютер разработчика (ip: 192.168.0.2) Ubuntu 10.10 с установленным <a href="http://netbeans.org/downloads/index.html">NetBeans 7.0m2</a></p>

<p>Сайт будет располагаться в <strong>/var/www/yii/www</strong>, а yii в <strong>/var/www/yii-lib/yii</strong></p>

<p>Действия на сервере
Создаём папку, где будет располагаться сайт.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p /var/www/yii/{logs,tmp,www}
</span><span class='line'>chown www-data.www-data /var/www/yii/{tmp,www}
</span><span class='line'>chmod 0700 /var/www/yii/{tmp,www}</span></code></pre></td></tr></table></div></figure>


<p>Создаём конфиг для php5-fpm. Файл: <strong>/etc/php5/fpm/pool.d/yii.conf</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[yii]
</span><span class='line'>listen = /var/run/php5-fpm/yii.sock
</span><span class='line'>listen.owner = www-data
</span><span class='line'>listen.group = www-data
</span><span class='line'>listen.mode = 0660
</span><span class='line'>
</span><span class='line'>user = www-data
</span><span class='line'>group = www-data
</span><span class='line'>
</span><span class='line'>pm = dynamic
</span><span class='line'>pm.max_children = 50
</span><span class='line'>pm.start_servers = 1
</span><span class='line'>pm.min_spare_servers = 1
</span><span class='line'>pm.max_spare_servers = 5
</span><span class='line'>pm.max_requests = 500
</span><span class='line'>
</span><span class='line'>pm.status_path = /status
</span><span class='line'>ping.path = /ping
</span><span class='line'>ping.response = pong
</span><span class='line'>; Это значение стоит увеличить при активном использовании xdebug, иначе скрипт отвалится. Также нужно соответственно изменить в nginx параметр fastcgi_read_timeout.
</span><span class='line'>request_terminate_timeout = 5m
</span><span class='line'>request_slowlog_timeout = 2s
</span><span class='line'>slowlog = /var/www/yii/logs/php-fpm.slow.log
</span><span class='line'>chdir = /var/www/yii/www
</span><span class='line'>catch_workers_output = yes
</span><span class='line'>
</span><span class='line'>env[TMP] = /var/www/yii/tmp
</span><span class='line'>env[TMPDIR] = /var/www/yii/tmp
</span><span class='line'>env[TEMP] = /var/www/yii/tmp
</span><span class='line'>
</span><span class='line'>php_flag[display_errors] = on
</span><span class='line'>php_admin_value[error_log] = /var/www/yii/logs/fpm-php.log
</span><span class='line'>php_admin_flag[log_errors] = on
</span><span class='line'>
</span><span class='line'>php_admin_value[open_basedir] = /var/www/yii/www:/var/www/yii/tmp:/var/www/yii/yii
</span><span class='line'>php_admin_value[upload_tmp_dir] = /var/www/yii/tmp
</span><span class='line'>php_admin_value[session.save_path] = /var/www/yii/tmp</span></code></pre></td></tr></table></div></figure>


<p>Конфигурация сайта для nginx. Файл: <strong>/etc/nginx/sites-available/yii</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>upstream yii {
</span><span class='line'>  server unix:/var/run/php5-fpm/yii.sock;
</span><span class='line'>}
</span><span class='line'>server {
</span><span class='line'>  listen   80;
</span><span class='line'>  server_name yii.local;
</span><span class='line'>  server_tokens off;
</span><span class='line'>  server_name_in_redirect  off;
</span><span class='line'>
</span><span class='line'>  access_log /var/www/yii/logs/nginx.access.log gzip;
</span><span class='line'>  error_log /var/www/yii/logs/nginx.error.log warn;
</span><span class='line'>
</span><span class='line'>  # ОБЯЗАТЕЛЬНО нужно отключить gzip, потому что тесты selenium не будет работать
</span><span class='line'>  gzip off;
</span><span class='line'>  charset utf-8;
</span><span class='line'>  client_max_body_size 1m;
</span><span class='line'>  fastcgi_intercept_errors on;
</span><span class='line'>
</span><span class='line'>  # Это значение стоит увеличить при активном использовании xdebug, иначе скрипт отвалится. Также нужно соответственно изменить в php5-fpm параметр request_terminate_timeout.
</span><span class='line'>  fastcgi_read_timeout 600;
</span><span class='line'>  root /var/www/yii/www;
</span><span class='line'>  index index.php index.html index.htm;
</span><span class='line'>
</span><span class='line'>  location ~ /.ht
</span><span class='line'>  {
</span><span class='line'>    deny all;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location ~ /(.git|protected)/ {
</span><span class='line'>    deny all;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location ~ /(assets|css)/ {
</span><span class='line'>    expires 7d;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location / {
</span><span class='line'>    try_files $uri $uri/ @php;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location ~ \.php$ {
</span><span class='line'>    try_files $uri @php;
</span><span class='line'>    fastcgi_pass yii;
</span><span class='line'>    fastcgi_index index.php;
</span><span class='line'>    fastcgi_param SCRIPT_FILENAME /var/www/yii/www$fastcgi_script_name;
</span><span class='line'>    include fastcgi_params;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location @php {
</span><span class='line'>    fastcgi_pass yii;
</span><span class='line'>    fastcgi_index index.php;
</span><span class='line'>    fastcgi_param SCRIPT_FILENAME /var/www/yii/www/index.php;
</span><span class='line'>    fastcgi_param SCRIPT_NAME /index.php;
</span><span class='line'>    fastcgi_param QUERY_STRING q=$uri&$args;
</span><span class='line'>    include fastcgi_params;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Включаем сайт, путём линкования в папку sites-enabled.</p>

<p>Скачивание yii</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Скачиваем исходники yii
</span><span class='line'>cd /usr/local/src
</span><span class='line'>wget http://yii.googlecode.com/files/yii-1.1.4.r2429.tar.gz
</span><span class='line'>mkdir -p /var/www/yii-lib/
</span><span class='line'>tar xvfz yii-1.1.4.r2429.tar.gz -C /var/www/yii-lib/
</span><span class='line'>cd /var/www/yii-lib/
</span><span class='line'># Делаем линк на текущую версию
</span><span class='line'>ln -s yii-1.1.4.r2429 yii
</span><span class='line'># Меняем пользователя и группу
</span><span class='line'>chown -R www-data.www-data /var/www/yii-lib/
</span><span class='line'># Создаём веб-приложение
</span><span class='line'>/var/www/yii-lib/yii/framework/yiic webapp /var/www/yii/www/
</span><span class='line'>Create a Web application under '/var/www/yii/www'? [Yes|No] Y
</span><span class='line'># Меняем пользователя и группу
</span><span class='line'>chown -R www-data.www-data /var/www/yii/www</span></code></pre></td></tr></table></div></figure>


<p>Устанавливаем php5-xdebug</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude install php5-xdebug</span></code></pre></td></tr></table></div></figure>


<p>Настраиваем xdebug для работы отладки <strong>/etc/php5/fpm/conf.d/xdebug.ini</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zend_extension=/usr/lib/php5/20090626+lfs/xdebug.so
</span><span class='line'>
</span><span class='line'>xdebug.remote_enable=on
</span><span class='line'>xdebug.remote_handler=dbgp
</span><span class='line'>xdebug.remote_mode=req
</span><span class='line'># Ip-адрес компьютера разработчика
</span><span class='line'>xdebug.remote_host=192.168.0.2
</span><span class='line'>xdebug.remote_log="/var/log/xdebug.log"
</span><span class='line'># По-умолчанию, используется 9000 порт, но он у меня уже занят.
</span><span class='line'>xdebug.remote_port=9009
</span><span class='line'>xdebug.idekey=netbeans-xdebug</span></code></pre></td></tr></table></div></figure>


<p>Рестартим fpm и apache:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>invoke-rc.d php5-fpm restart
</span><span class='line'>invoke-rc.d apache2 restart</span></code></pre></td></tr></table></div></figure>


<p>Настройка компьютера разработчика
Я монтирую всю папку /var/www к себе. Это очень удобно, т.к. не нужно скачивать все файлы с сайта. Нужен пакет sshfs.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo mkdir -p /mnt/www
</span><span class='line'>sudo chown ВЫ.ВЫ /mnt/www
</span><span class='line'>sshfs www-data@192.168.0.3:/var/www /mnt/www</span></code></pre></td></tr></table></div></figure>


<p>Прописываем в <strong>/etc/hosts</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.0.3 yii.local</span></code></pre></td></tr></table></div></figure>


<h3>Phpunit</h3>

<p>Устанавливаем
<img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-1.png" alt="phpunit" /></p>

<h3>Selenium</h3>

<p><a href="http://seleniumhq.org/download/">Скачиваем Selenium RC</a>. Распаковываем и запускаем:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -jar selenium/selenium-server-1.0.3/selenium-server.jar</span></code></pre></td></tr></table></div></figure>


<h3>Netbeans</h3>

<p>Устанавливаем <a href="http://netbeans.org/downloads/index.html">NetBeans</a> (в моём случае это NetBeans 7.0m2). Ставим плагин <strong>Selenium Module for PHP</strong> (Tools → Plugins → Available Plugins).</p>

<p>Немного настраиваем (Tools → Options):</p>

<p>Php → General Ставим порт 9009 для xdebug и снимаем галку с опции <strong>Stop at First Line</strong>.</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-2.png" alt="phpunit" /></p>

<p>Php → Unit Testing Указываем путь до phpunit: /usr/bin/phpunit</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-31.png" alt="phpunit" /></p>

<p>Miscellaneous → Files Исключаем файл yiilite.php, чтобы при автокомплите подсказки не дублировались <strong>^(yiilite.php|CVS|</strong></p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-16.png" alt="phpunit" /></p>

<p>Создаём новый проект:</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-4.png" alt="phpunit" /></p>

<p>Указываем пути, название проект. Meta-файлы сохраняем в другой директории.</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-5.png" alt="phpunit" /></p>

<p>Указываем url проекта: <a href="http://yii.local/">http://yii.local/</a></p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-6.png" alt="phpunit" /></p>

<p>Теперь вызываем настройки проекта.</p>

<p>Указываем директорию тестов (File → Project properties → Sources → Test Folder)</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-8.png" alt="phpunit" /></p>

<p>Задаём маппинг пути (File → Project properties → Run configuration → Advanced). Тут не видно, но указано, что /var/www доступно в /mnt/www.</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-9.png" alt="phpunit" /></p>

<p>Указываем директорию с yii: <strong>/mnt/www/yii-lib/yii</strong> (File → Project properties → PHP Include Path)</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-10.png" alt="phpunit" /></p>

<p>Папки, которые будут игнорироваться: <strong>/mnt/www/yii/www/protected/runtime</strong> (File → Project properties → Ignored Folders → Add Folder).</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-11.png" alt="phpunit" /></p>

<p>Настройка phpunit (File → Project properties → PhpUnit).</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-12.png" alt="phpunit" /></p>

<p>Открываем файлы index.php, index-test.php, protected/tests/bootstrap.php и заменяем <strong>/yii-1.1.4.r2429/</strong> на <strong>/yii/</strong></p>

<p>Удалить из <strong>protected/tests/phpunit.xml</strong> тест под IE</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;browser name="Internet Explorer" browser="*iexplore" /></span></code></pre></td></tr></table></div></figure>


<p>Меняем константу TEST_BASE_URL в файле protected/tests/WebTestCase.php:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define('TEST_BASE_URL','http://yii.local/index-test.php');</span></code></pre></td></tr></table></div></figure>


<p>Правим тест <strong>protected/tests/functional/SiteTest.php (баг)</strong>:</p>

<p>Заменяем $this->clickAndWait(&lsquo;link=Logout&rsquo;); на $this->clickAndWait(&lsquo;link=Logout (demo)&rsquo;);</p>

<p>Теперь можно запустить тест Selenium</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-13.png" alt="phpunit" /></p>

<p>Появиться окошко выбора папки с этими тестами, указываем: /mnt/www/yii/www/protected/tests/functional</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-14.png" alt="phpunit" /></p>

<p>Будут всплывать окошки с firefox&#8217;ом и в конце концов появиться результат:</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-15.png" alt="phpunit" /></p>

<h3>Phpunit</h3>

<p>Можно запускать phpunit тесты прямо с сервера или с рабочего компьютера, но придётся установить php и все используемые библиотеки (php5-pgsql, php5-mysql, etc). Рассмотрим 2-ой вариант. На компьютере разработчика установить phpunit и php5: Для phpunit теста можно установить свои параметры для yii в protected/config/test.php поверх стандартных (например, коннект к базе). Напишем простейший тест для проверки авторизации. Файл protected/tests/unit/AuthTest.php:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt; ?php
</span><span class='line'>class AuthTest extends CTestCase
</span><span class='line'>{
</span><span class='line'>  public function testAuth()
</span><span class='line'>  {
</span><span class='line'>    $login = new LoginForm;
</span><span class='line'>    $login->username = 'demo';
</span><span class='line'>    $login->password = 'demo';
</span><span class='line'>    $this->assertTrue($login->login());
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Для выполнения теста в Netbeans нажимаем Alt+F6. При этом выполняться все тесты: и phpunit и selenium.</p>

<p><img src="/images/configure-netbeans-to-yii-with-xdebug-unit-tests/netbeans_yii-17.png" alt="phpunit" /></p>

<p>Можно выбрать AuthTest.php и нажать Shift+F6, тогда тестирование выполниться только из этого файла. Также можно выполнять phpunit тесты прямо с сервера (aptitude install phpunit):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /var/www/yii/www/protected/tests/
</span><span class='line'>phpunit unit/AuthTest.php
</span><span class='line'>PHPUnit 3.4.14 by Sebastian Bergmann.
</span><span class='line'>
</span><span class='line'>.
</span><span class='line'>
</span><span class='line'>Time: 0 seconds, Memory: 7.25Mb
</span><span class='line'>
</span><span class='line'>OK (1 test, 1 assertion)</span></code></pre></td></tr></table></div></figure>


<p>Также можно написать тесты, не использую базу данных, подменив некоторые таблицы fixtures &ndash; ассоциативным массивом, имитирующим записи в таблице.</p>

<p>Дебагинг кода
Тесты написаны, теперь можно дебажить код. Открываем index.php, на любой строке добавляем breakpoint (Ctrl+F8). Запускаем дебагинг (Ctrl+F5). Теперь можно &ldquo;пройтись&rdquo; по коду клавишами F7 (Step Into) и F8 (Step Over). Это очень помогает понять как же работает сам yii, а так же &ldquo;качественно&rdquo; дебажить код, видя текущие переменные, watches, Call stack.</p>

<p>Советую всем прочитать книгу <a href="http://www.amazon.com/dp/1847199585?tag=gii20f-20&amp;camp=0&amp;creative=0&amp;linkCode=as1&amp;creativeASIN=1847199585&amp;adid=0BHF2HS6FNS82M85KJQT">Agile Web Application Development with Yii1.1 and PHP5</a> всем, кто работает с yii. Книга поднимет уровень и в правильном написании кода для yii, и английского языка.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/mysql-query-console/">MySQL запросы через консоль</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-14T14:05:00+04:00" pubdate data-updated="true">2010-09-14</time>
        
         | <a href="/mysql-query-console/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Обнаружил очень простой способ выполнения MySQL запросов в Debian. Причём без указания логина и пароля. В Debian&#8217;е создаётся системный пользователь debian-sys-maint, от которого и будут идти запросы. Например выборка:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo "SELECT * FROM database.table WHERE id > 10" | mysql --defaults-file=/etc/mysql/debian.cnf -Bs</span></code></pre></td></tr></table></div></figure>


<p>Можно мониторить нагрузку:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>watch 'echo "show full processlist" | mysql --defaults-file=/etc/mysql/debian.cnf -Bs'</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/apt-pinning-packages-stable-testing-unstable-experimental/">Apt: управление приоритетами пакетов из Stable, Testing, Unstable, Experimental</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-20T01:22:00+04:00" pubdate data-updated="true">2010-08-20</time>
        
         | <a href="/apt-pinning-packages-stable-testing-unstable-experimental/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Есть несколько &ldquo;виртуальных&rdquo; релизов у debian: stable &ndash; на текущий момент это 5 версия (lenny), testing &ndash; squeeze (когда он будет выпущен, то перейдёт в релиз stable). Unstable и experimental &ndash; экспериментальные релизы, не для продакшена!. Пакет проходит путь из experimental => unstable => testing => stable. Иногда бывают ситуации, когда нужно установить пакеты поновее. Можно, конечно, скачать отдельно deb-пакет и установить его, но в этом случае одни минусы: возможно требуются удовлетворения зависимостей и лишаемся обновлений. А можно рулить приоритетами пакетов в зависимости от релиза (stable, testing, unstable, experimental).</p>

<p>Создаём файлы в /etc/apt/sources.list.d</p>

<p>testing.list</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://ftp.debian.org/debian/ testing main non-free contrib
</span><span class='line'>deb-src http://ftp.debian.org/debian/ testing main non-free contrib
</span><span class='line'>deb http://security.debian.org/ testing/updates main contrib non-free
</span><span class='line'>deb-src http://security.debian.org/ testing/updates main contrib non-free</span></code></pre></td></tr></table></div></figure>


<p>unstable.list</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://ftp.debian.org/debian/ sid main non-free contrib
</span><span class='line'>deb-src http://ftp.debian.org/debian/ sid main non-free contrib</span></code></pre></td></tr></table></div></figure>


<p>experimental.list</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://ftp.debian.org/debian/ experimental main non-free contrib
</span><span class='line'>deb-src http://ftp.debian.org/debian/ experimental main non-free contrib</span></code></pre></td></tr></table></div></figure>


<p>Теперь настраиваем приоритеты в файле /etc/apt/preferences:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Package: *
</span><span class='line'>Pin: release a=stable
</span><span class='line'>Pin-Priority: 200
</span><span class='line'>
</span><span class='line'>Package: *
</span><span class='line'>Pin: release a=testing
</span><span class='line'>Pin-Priority: 201
</span><span class='line'>
</span><span class='line'>Package: *
</span><span class='line'>Pin: release a=unstable
</span><span class='line'>Pin-Priority: 199
</span><span class='line'>
</span><span class='line'>Package: *
</span><span class='line'>Pin: release a=experimental
</span><span class='line'>Pin-Priority: 198</span></code></pre></td></tr></table></div></figure>


<p>Этот конфиг означает, что пакеты будут искаться в такой последовательности: testing => stable => unstable => experimental. Вместо Package: * можно указать конкретные пакеты, но, к сожалению, нельзя указать маску пакетов.</p>

<p>Установка пакета и попытка решить зависимости из unstable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude -t unstable install &lt;package></span></code></pre></td></tr></table></div></figure>


<p>Установка пакета и попытка решить зависимости из релиза с наивысшим приоритетом:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude install &lt;package>/unstable</span></code></pre></td></tr></table></div></figure>


<p>Ссылки по теме: <a href="http://www.debian.org/doc/manuals/apt-howto/ch-apt-get.ru.html">http://www.debian.org/doc/manuals/apt-howto/ch-apt-get.ru.html</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/bash-completion/">Bash Completion - расширенная автоподстановка</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-09T14:01:00+04:00" pubdate data-updated="true">2010-08-09</time>
        
         | <a href="/bash-completion/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Очень нужная тулза для ленивых админов. Может работать автодополнением для разных консольных программ: aptitude, git, invoke-rc.d, ssh и других.</p>

<p>Список поддерживающих программ находиться в директории /etc/bash_completion.d</p>

<p>По желанию можно самому расширить этот список. Не забудьте прислать ваши труды мейнтейнеру пакета.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude install bash-completion</span></code></pre></td></tr></table></div></figure>


<p>Добавляем в ~/.bashrc</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Use bash-completion, if available
</span><span class='line'>if [ -f /etc/bash_completion ]; then
</span><span class='line'>  . /etc/bash_completion
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/debian-4-configure-web-server-nginx-apache-mysql-postgresql/">Debian. Часть 4. Настройка веб-сервера: Nginx, Apache, Mysql, Postgresql</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-28T01:14:00+04:00" pubdate data-updated="true">2010-07-28</time>
        
         | <a href="/debian-4-configure-web-server-nginx-apache-mysql-postgresql/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>У меня работает связка nginx &ndash;> apache2 + mysql + postgresql. Поставим memcached, APC (кэшер для php), и несколько модулей для php5.</p>

<p>Для того, чтобы nginx проксировал через локальный адрес (192.168.1.254, например), необходимо добавить в bind наш домен. Это ещё пригодиться для доступа из локальной сети, чтобы запросы не шли через «внешку», а также для однозначной идентификации того, что заходят из «доверенной» сети. Добавляем в файл /etc/bind/named.conf.local наш домен:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zone "zagirov.name" {
</span><span class='line'>    type master;
</span><span class='line'>    file "/etc/bind/db.zagirov.name";
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>Создаём файл /etc/bind/db.zagirov.name:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$TTL    604800
</span><span class='line'>@   IN  SOA zagirov.name. root.zagirov.name. (
</span><span class='line'>                  2     ; Serial
</span><span class='line'>             604800     ; Refresh
</span><span class='line'>              86400     ; Retry
</span><span class='line'>            2419200     ; Expire
</span><span class='line'>             604800 )   ; Negative Cache TTL
</span><span class='line'>;
</span><span class='line'>@   IN  NS  localhost.
</span><span class='line'>@   IN  A   192.168.1.254
</span><span class='line'>*   IN  A   192.168.1.254</span></code></pre></td></tr></table></div></figure>


<p>Я использую Debian testing (squeeze). Устанавливаем пакеты:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude install apache2 nginx libapache2-mod-php5 php5-cli php5-mysql php5-pgsql php5-xmlrpc php5-gd php5-curl php5-xsl php-apc memcached php5-memcache mysql-server postgresql</span></code></pre></td></tr></table></div></figure>


<p>Структура папок сайта: logs – логи tmp – папка для временных файлов и файлов сессии www – содержимое сайта</p>

<p>Создадим «эталонную» папку для сайта, которая будет структурой для будущих сайтов</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir - p /var/www/etalon/{logs,tmp,www}
</span><span class='line'>chown www-data.www-data /var/www/etalon/{tmp,www}
</span><span class='line'>chmod 0700 /var/www/etalon/{tmp,www}</span></code></pre></td></tr></table></div></figure>


<p>Открываем в mc папку /var/www/, выбираем папку etalon, нажимает shift+F5, вводим название сайта(zagirov.name). Появилась папка для будущего сайта: /var/www/zagirov.name/ Чтобы логи архивировались, создаём правило для logrotate в файле /etc/logrotate.d/sites:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/var/www/*/logs/*.log {
</span><span class='line'>    weekly
</span><span class='line'>    missingok
</span><span class='line'>    rotate 52
</span><span class='line'>    compress
</span><span class='line'>    delaycompress
</span><span class='line'>    notifempty
</span><span class='line'>    create 644 root root
</span><span class='line'>    sharedscripts
</span><span class='line'>    postrotate
</span><span class='line'>        if [ -f "`. /etc/apache2/envvars ; echo ${APACHE_PID_FILE:-/var/run/apache2.pid}`" ]; then
</span><span class='line'>            /etc/init.d/apache2 reload > /dev/null
</span><span class='line'>        fi
</span><span class='line'>        [ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`
</span><span class='line'>    endscript
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Теперь настраиваем nginx. Удаляем все символические ссылки из папки /etc/nginx/sites-enabled Создаём конфигурацию для неописанных доменов: /etc/nginx/sites-available/default_http В случае, когда сайт не описан nginx просто разорвёт соединение, ничего не выдав.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>    listen          80 default;
</span><span class='line'>    server_name     _;
</span><span class='line'>    access_log      off;
</span><span class='line'>    server_name_in_redirect  off;
</span><span class='line'>    return 444;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Открываем mc. В левой панели /etc/nginx/sites-enabled, в правой – /etc/nginx/sites-available Выбираем файл default_http и нажимаем комбинацию Ctrl+X, а затем S – это создаст символическую ссылку выбранного файла в папке другой панели. Теперь создадим файл для сайта /etc/nginx/sites-available/zagirov.name:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>    listen   80;
</span><span class='line'>    server_name zagirov.name www.zagirov.name rustam.zagirov.name;
</span><span class='line'>
</span><span class='line'>    server_tokens off;
</span><span class='line'>
</span><span class='line'>    access_log /var/www/zagirov.name/logs/nginx.access.log;
</span><span class='line'>    error_log /var/www/zagirov.name/logs/nginx.error.log warn;
</span><span class='line'>
</span><span class='line'>    charset utf-8;
</span><span class='line'>    client_max_body_size 1m;
</span><span class='line'>
</span><span class='line'>    root /var/www/zagirov.name/www;
</span><span class='line'>    index index.php index.html index.htm;
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>        #Реврайт
</span><span class='line'>        #try_files $uri $uri /index.php?q=$uri&$args;
</span><span class='line'>
</span><span class='line'>        proxy_pass http://zagirov.name:81;
</span><span class='line'>        include proxy.conf;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    #Тут перечисляем все пути и файлы статики (картинки, стили)
</span><span class='line'>    location ~ /(favicon.ico|wp-content/uploads/|wp-content/themes/openark-blog/(images/|style.css)) {
</span><span class='line'>        expires 7d;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Опять включаем сайт созданием символической ссылки.</p>

<p>Теперь настраиваем apache. Удаляем включённые по дефолту сайты из папки /etc/apache2/sites-enabled Меняем порт с 80 на 81 в файле /etc/apache2/ports.conf:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NameVirtualHost *:81
</span><span class='line'>Listen 81</span></code></pre></td></tr></table></div></figure>


<p>Создаём конфигурацию для неописанных доменов: /etc/apache2/sites-available/default_http</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;virtualhost *:81>
</span><span class='line'>    ServerName default
</span><span class='line'>&lt;/virtualhost></span></code></pre></td></tr></table></div></figure>


<p>Создадим настройки для сайта в файле /etc/apache2/sites-available/zagirov.name:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;virtualhost *:81>
</span><span class='line'>    ServerName zagirov.name
</span><span class='line'>    ServerAlias www.zagirov.name rustam.zagirov.name
</span><span class='line'>    DocumentRoot /var/www/zagirov.name/www
</span><span class='line'>    ErrorLog /var/www/zagirov.name/logs/apache2.error.log
</span><span class='line'>    CustomLog /var/www/zagirov.name/logs/apache2.access.log combined
</span><span class='line'>    AddDefaultCharset UTF8
</span><span class='line'>    php_flag magic_quotes_gpc off
</span><span class='line'>    php_admin_value open_basedir "/var/www/zagirov.name/www"
</span><span class='line'>    php_admin_value upload_tmp_dir "/var/www/zagirov.name/tmp"
</span><span class='line'>    php_value session.save_path "/var/www/zagirov.name/tmp"
</span><span class='line'>&lt;/virtualhost></span></code></pre></td></tr></table></div></figure>


<p>Включаем сайт:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>a2ensite zagirov.name</span></code></pre></td></tr></table></div></figure>


<p>Перезапускаем apache и nginx.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>invoke-rc.d apache2 restart
</span><span class='line'>invoke-rc.d nginx restart</span></code></pre></td></tr></table></div></figure>


<p>Установка рутового пароля для пользователя postgres для PostgreSQL:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>su postgres
</span><span class='line'>psql -d template1
</span><span class='line'>ALTER USER postgres WITH PASSWORD 'Str0ng passw0rd';</span></code></pre></td></tr></table></div></figure>


<p><a href="/debian-3-setting-iptables-forward-nat-firewall">← Часть 3</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/debian-3-setting-iptables-forward-nat-firewall/">Debian. Часть 3. Настройка Iptables: NAT, фаервол</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-28T00:59:00+04:00" pubdate data-updated="true">2010-07-28</time>
        
         | <a href="/debian-3-setting-iptables-forward-nat-firewall/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Фаервол нам нужен для ограничения подключения из вне, NATа, а также проброса портов. Для удоства написал скрипт на bash. Вставляем в файл /etc/init.d/rc.firewall</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>IPTABLES="/sbin/iptables"
</span><span class='line'>
</span><span class='line'>############### Config #######
</span><span class='line'>LNETS="eth1 eth2 wlan0"
</span><span class='line'>
</span><span class='line'>DESKTOP="192.168.1.1"
</span><span class='line'>DESKTOP_OPEN_PORT="8010 9000"
</span><span class='line'>
</span><span class='line'>DESKTOP2="192.168.2.1"
</span><span class='line'>DESKTOP2_OPEN_PORT="9003"
</span><span class='line'>
</span><span class='line'>HOME_MASKS="192.168.1.0/24 192.168.2.0/24 192.168.3.0/24"
</span><span class='line'>
</span><span class='line'>PROVIDER="eth0"
</span><span class='line'>PROVIDER_IP="10.0.4.59"
</span><span class='line'>PROVIDER_MASK="10.0.0.0/8"
</span><span class='line'>INET="ppp+"
</span><span class='line'>WHITE_IP="77.77.77.77"
</span><span class='line'>
</span><span class='line'>OPEN_PORTS="22,80"
</span><span class='line'>###################
</span><span class='line'>echo 1 > /proc/sys/net/ipv4/conf/default/rp_filter
</span><span class='line'>echo 1 > /proc/sys/net/ipv4/ip_forward
</span><span class='line'>modprobe ip_conntrack
</span><span class='line'>modprobe ip_conntrack_ftp
</span><span class='line'>modprobe nf_nat_pptp
</span><span class='line'>modprobe nf_conntrack_pptp
</span><span class='line'>modprobe nf_conntrack_proto_gre
</span><span class='line'>modprobe nf_nat_proto_gre
</span><span class='line'>modprobe iptable_nat
</span><span class='line'>modprobe ip_nat_ftp
</span><span class='line'>modprobe ipt_LOG
</span><span class='line'>
</span><span class='line'>$IPTABLES -P INPUT ACCEPT
</span><span class='line'>$IPTABLES -P OUTPUT ACCEPT
</span><span class='line'>$IPTABLES -P FORWARD DROP
</span><span class='line'>
</span><span class='line'>$IPTABLES -F
</span><span class='line'>$IPTABLES -X
</span><span class='line'>$IPTABLES -t nat -F PREROUTING
</span><span class='line'>$IPTABLES -t nat -F POSTROUTING
</span><span class='line'>
</span><span class='line'>############ DELETE IF ALL WORKING FINE ###### 
</span><span class='line'>#$IPTABLES -A INPUT -j ACCEPT
</span><span class='line'>#####################################
</span><span class='line'>
</span><span class='line'>#mtu for vpn magick command, mega debian epic fail
</span><span class='line'>$IPTABLES -o $INET -A FORWARD -p tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 800:1536 -j TCPMSS --clamp-mss-to-pmtu
</span><span class='line'>
</span><span class='line'># DENY SECTIONS
</span><span class='line'>$IPTABLES -A INPUT -p tcp ! --syn -m state --state NEW -j DROP
</span><span class='line'>$IPTABLES -A INPUT -p tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW -j DROP
</span><span class='line'>
</span><span class='line'># local interface, allow all
</span><span class='line'>$IPTABLES -A INPUT -i lo -j ACCEPT
</span><span class='line'>
</span><span class='line'># ALLOW PACKETS IF CONNECTION ESTABLISHED
</span><span class='line'>$IPTABLES -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</span><span class='line'>
</span><span class='line'># access from white ip
</span><span class='line'>$IPTABLES -A INPUT -s $WHITE_IP -j ACCEPT
</span><span class='line'>
</span><span class='line'># access from home net
</span><span class='line'>for i in $HOME_MASKS; do
</span><span class='line'>$IPTABLES -A INPUT -s $i -j ACCEPT
</span><span class='line'>done
</span><span class='line'># defence for ssh for server
</span><span class='line'>$IPTABLES -A INPUT -p tcp -m state --state NEW --dport 22 -m recent --update --seconds 20 -j DROP 
</span><span class='line'>$IPTABLES -A INPUT -p tcp -m state --state NEW --dport 22 -m recent --set -j ACCEPT
</span><span class='line'>
</span><span class='line'># open ports for server
</span><span class='line'>$IPTABLES -A INPUT -p tcp --syn -m multiport --destination-ports $OPEN_PORTS -j ACCEPT
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>######### FORWARD ##########
</span><span class='line'>$IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
</span><span class='line'>#forward each home eth to provider eth and ppp+
</span><span class='line'>for i in $LNETS; do
</span><span class='line'>  $IPTABLES -A FORWARD -i $INET -o $i -j ACCEPT
</span><span class='line'>  $IPTABLES -A FORWARD -i $i -o $INET -j ACCEPT
</span><span class='line'>  $IPTABLES -A FORWARD -i $i -o $PROVIDER -j ACCEPT
</span><span class='line'>  #forward each home eth to other home eth
</span><span class='line'>  for j in $LNETS; do
</span><span class='line'>    if [ "$i" != "$j" ] ; then
</span><span class='line'>      $IPTABLES -A FORWARD -i $i -o $j -j ACCEPT
</span><span class='line'>      $IPTABLES -A FORWARD -i $j -o $i -j ACCEPT
</span><span class='line'>    fi
</span><span class='line'>  done
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'>###########################
</span><span class='line'>
</span><span class='line'>######### LOCAL NAT ########
</span><span class='line'>for i in $HOME_MASKS; do
</span><span class='line'>  $IPTABLES -t nat -A POSTROUTING -s $i -d $PROVIDER_MASK -j SNAT --to-source $PROVIDER_IP
</span><span class='line'>done
</span><span class='line'>############################
</span><span class='line'>
</span><span class='line'>######### INET NAT #########
</span><span class='line'>for i in $HOME_MASKS; do
</span><span class='line'>  $IPTABLES -t nat -A POSTROUTING -s $i -j SNAT --to-source $WHITE_IP
</span><span class='line'>done 
</span><span class='line'>############################
</span><span class='line'>
</span><span class='line'>########## FORWARD PORTS #########
</span><span class='line'>for i in $DESKTOP_OPEN_PORT; do
</span><span class='line'>  $IPTABLES -t nat -A PREROUTING -p tcp --dport $i -j DNAT --to $DESKTOP:$i
</span><span class='line'>  $IPTABLES -A FORWARD -p tcp -d $DESKTOP --dport $i -j ACCEPT
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'>for i in $DESKTOP2_OPEN_PORT; do
</span><span class='line'>  $IPTABLES -t nat -A PREROUTING -p tcp --dport $i -j DNAT --to $DESKTOP2:$i
</span><span class='line'>  $IPTABLES -A FORWARD -p tcp -d $DESKTOP2 --dport $i -j ACCEPT
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'># ssh for destop with defence
</span><span class='line'>$IPTABLES -t nat -A PREROUTING -p tcp --dport 12345 -j DNAT --to $DESKTOP:22
</span><span class='line'>$IPTABLES -A FORWARD -p tcp -m state -d $DESKTOP --state NEW --dport 12345 -m recent --update --seconds 20 -j DROP
</span><span class='line'>$IPTABLES -A FORWARD -p tcp -m state -d $DESKTOP --state NEW --dport 12345 -m recent --set -j ACCEPT   
</span><span class='line'>
</span><span class='line'># ping
</span><span class='line'>$IPTABLES -A INPUT -p ICMP --icmp-type 8 -j ACCEPT
</span><span class='line'># deny other ICMP packets
</span><span class='line'>$IPTABLES -A INPUT -p icmp -j DROP
</span><span class='line'>
</span><span class='line'># other reject
</span><span class='line'>$IPTABLES -A INPUT -j DROP $IPTABLES -A FORWARD -j DROP</span></code></pre></td></tr></table></div></figure>


<p>Делаем скрипт исполняемым:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chmod +x /etc/init.d/rc.firewall</span></code></pre></td></tr></table></div></figure>


<p>И прописываем в автозагрузку</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>update-rc.d rc.firewall defaults</span></code></pre></td></tr></table></div></figure>


<p>По сути в нём всё лаконично закоментированно, но iptables – та ещё магия. В скрипте почти все настройки вынесены. Скрипт разрешает форвардинг между всеми интерфейсами, включает NAT, разрешает пинги до сервера. Всё что явно не разрешено, то запрещено. Бонусом есть защита ssh от брута, форвардинг ssh с порта 12345 на 22 порт домашнего компьютера, форвардинг портов на внутренние компьютеры (разделяются пробелом) Там найдёте магическую строку с моим негативом. Дебиан почему-то не может поставить MTU для ppp. Всё бы ничего, но некоторые сайты не открываются (nix.ru, mail.ru). Как говорят знакомые админы баг тянется ещё с etch. Отписал баг-репорт, ничего внятного так и не ответили. В Ubuntu 9.10, когда настраивал VPN скриптом, всё с mtu было нормально. Благодарю нашего админа за предоставление конфигов и помощи в настройках Теперь у всех домашних компьютеров есть интернет и настроен фаервол. Следующие статьи будут о полезных программах, настройке веб-сервера.</p>

<p><a href="/debian-2-setting-network-dhcp-bind9-vpn">← Часть 2</a> | <a href="/debian-4-configure-web-server-nginx-apache-mysql-postgresql">Часть 4 →</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/debian-2-setting-network-dhcp-bind9-vpn/">Debian. Часть 2. Настройка сети: Dhcp, Bind9, Vpn, Wifi-точка на карте Dlink Dwa-520</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-28T00:50:00+04:00" pubdate data-updated="true">2010-07-28</time>
        
         | <a href="/debian-2-setting-network-dhcp-bind9-vpn/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>После установки, сперва настроим локальную сеть провайдера и vpn для интернета. Напоминаю схема сети:</p>

<p><img src="/images/debian-1-install/schema.png" alt="Схема сети" /></p>

<p>Локальная сеть провайдера будет на интерфейсе eth0. Внутренняя сеть на интерфейсах eth1 и eth2.</p>

<p>Сами настройки сети находятся в файле: /etc/network/interfaces</p>

<p>Настройки сети провайдера: ip: 10.0.4.59, маска: 255.255.255.0, шлюз: 10.0.4.254, dns: 10.0.0.1 и 10.0.0.10</p>

<p>В домашней сети у сервера будут ip 192.168.1.254 и 192.168.2.254</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nano /etc/network/interfaces</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'># The primary network interface
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet static
</span><span class='line'>   address 10.0.4.59
</span><span class='line'>   netmask 255.255.255.0
</span><span class='line'>   network 10.0.4.0
</span><span class='line'>   broadcast 10.0.4.255
</span><span class='line'>   gateway 10.0.4.254
</span><span class='line'>   dns-nameservers 10.0.0.1 10.0.0.10
</span><span class='line'>
</span><span class='line'>auto eth1
</span><span class='line'>iface eth1 inet static
</span><span class='line'>   address 192.168.1.254
</span><span class='line'>   netmask 255.255.255.0
</span><span class='line'>   network 192.168.1.0
</span><span class='line'>   broadcast 192.168.1.255
</span><span class='line'>   gateway 192.168.1.254
</span><span class='line'>
</span><span class='line'>auto eth2
</span><span class='line'>iface eth2 inet static
</span><span class='line'>   address 192.168.2.254
</span><span class='line'>   netmask 255.255.255.0
</span><span class='line'>   network 192.168.2.0
</span><span class='line'>   broadcast 192.168.2.255
</span><span class='line'>   gateway 192.168.2.254
</span><span class='line'>
</span><span class='line'>auto wlan0
</span><span class='line'>iface wlan0 inet static
</span><span class='line'>   address 192.168.3.254
</span><span class='line'>   netmask 255.255.255.0
</span><span class='line'>   gateway 192.168.3.254</span></code></pre></td></tr></table></div></figure>


<p>Перезагружаем сеть</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>invoke-rc.d networking restart</span></code></pre></td></tr></table></div></figure>


<p>По команде ifconfig должно быть примерно следующее:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>eth0 Link encap:Ethernet  HWaddr 00:22:00:e2:0b:2f
</span><span class='line'>inet addr:10.0.4.59  Bcast:10.0.4.255  Mask:255.255.255.0
</span><span class='line'>inet6 addr: fe80::222:b0ff:fee2:b2f/64 Scope:Link
</span><span class='line'>UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span><span class='line'>RX packets:34344719 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>TX packets:28907703 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>collisions:0 txqueuelen:1000
</span><span class='line'>RX bytes:1153177468 (1.0 GiB)  TX bytes:3724435420 (3.4 GiB)
</span><span class='line'>Interrupt:16 Base address:0xc400
</span><span class='line'>
</span><span class='line'>eth1 Link encap:Ethernet  HWaddr 00:e0:0c:c0:c2:49
</span><span class='line'>inet addr:192.168.1.254  Bcast:192.168.1.255  Mask:255.255.255.0
</span><span class='line'>inet6 addr: fe80::2e0:4cff:fec0:c249/64 Scope:Link
</span><span class='line'>UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span><span class='line'>RX packets:333947 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>TX packets:397715 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>collisions:0 txqueuelen:1000
</span><span class='line'>RX bytes:35492580 (33.8 MiB)  TX bytes:466529275 (444.9 MiB)
</span><span class='line'>Interrupt:22
</span><span class='line'>
</span><span class='line'>eth2 Link encap:Ethernet  HWaddr 00:15:09:3c:d3:8f
</span><span class='line'>inet addr:192.168.2.254  Bcast:192.168.2.255  Mask:255.255.255.0
</span><span class='line'>inet6 addr: fe80::215:e9ff:fe3c:d38f/64 Scope:Link
</span><span class='line'>UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span><span class='line'>RX packets:21667974 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>TX packets:29063568 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>collisions:0 txqueuelen:1000
</span><span class='line'>RX bytes:902706969 (860.8 MiB)  TX bytes:90195099 (86.0 MiB)
</span><span class='line'>Interrupt:17 Base address:0xc000
</span><span class='line'>
</span><span class='line'>lo Link encap:Local Loopback
</span><span class='line'>inet addr:127.0.0.1  Mask:255.0.0.0
</span><span class='line'>inet6 addr: ::1/128 Scope:Host
</span><span class='line'>UP LOOPBACK RUNNING  MTU:16436  Metric:1
</span><span class='line'>RX packets:598219 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>TX packets:598219 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>collisions:0 txqueuelen:0
</span><span class='line'>RX bytes:117103916 (111.6 MiB)  TX bytes:117103916 (111.6 MiB)</span></code></pre></td></tr></table></div></figure>


<p>Втыкаем патч корд в сервер в сетевую карту eth1, а другой конец в главный десктоп. Пока что настройте на десктопе вручную сеть: ip: 192.168.1.1, маска: 255.255.255.0, шлюз 192.168.1.254.</p>

<p>Не всегда известно у сетевой карты интерфейс. Попробуйте с компьютера попинговать 192.168.1.254, если не пингуется, вставляйте в другую сетевуху до того момента, когда пинги появятся. Для удобства можно измененить названия интерфейсов (eth0, eth1, eth2 и т.д.) для сетевых карт. Для этого поправьте файл /etc/udev/rules.d/70-persistent-net.rules</p>

<p>Ставим пакеты ssh-server для удалённого управления сервером и pptp-linux для интернета. Во время установки не вынимайте CD диск с установщиком – на нём находятся эти пакеты.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude install openssh-server pptp-linux</span></code></pre></td></tr></table></div></figure>


<p>Теперь можно зайти на сервер по ssh с десктопа. На компьютере у меня Ubuntu 10.04, поэтому я захожу на сервер командой:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh root@192.168.1.254</span></code></pre></td></tr></table></div></figure>


<p>Принимаем rsa ключ и вводим пароль. Всё, мы на сервере.</p>

<p>Создаём настройки для vpn:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nano /etc/ppp/peers/tvoynet</span></code></pre></td></tr></table></div></figure>


<p>Настройки для vpn-соединения такие: сервер: vpn.tvoynet.ru, шифрование 128 бит</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pty "pptp vpn.tvoynet.ru --nolaunchpppd --nobuffer --loglevel 0"
</span><span class='line'>mtu 1492
</span><span class='line'>mru 1492
</span><span class='line'>connect /bin/true
</span><span class='line'>name ЛОГИН
</span><span class='line'>remotename PPTP
</span><span class='line'>require-mppe-128
</span><span class='line'>
</span><span class='line'>#Авто-переподнятие vpn
</span><span class='line'>persist
</span><span class='line'>#Количество попыток для переподнятия
</span><span class='line'>maxfail 0
</span><span class='line'>#Время между попытками переподнятия
</span><span class='line'>holdoff 20
</span><span class='line'>lcp-echo-interval 10
</span><span class='line'>lcp-echo-failure 4
</span><span class='line'>defaultroute
</span><span class='line'>replacedefaultroute
</span><span class='line'>
</span><span class='line'>lock
</span><span class='line'>noauth
</span><span class='line'>nodeflate
</span><span class='line'>nobsdcomp
</span><span class='line'>persist</span></code></pre></td></tr></table></div></figure>


<p>В конфигурации указано следующее: если через 40 секунд (4 раза по 10 секунд) не будет доступен интернет, то будет переподниматься vpn-соединение с промежутками 20 секунд до тех пор, пока соединение не подниметься. Записываем пароль в файл /etc/ppp/chap-secrets:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ЛОГИН PPTP ПАРОЛЬ</span></code></pre></td></tr></table></div></figure>


<p>Интернет подключается по команде</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pon tvoynet</span></code></pre></td></tr></table></div></figure>


<p>Отключается:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>poff tvoynet</span></code></pre></td></tr></table></div></figure>


<p>Добавляем маршруты для локальных ресурсов (и на всякий случай убираем дефолтные маршруты в домашних подсетях) и подключение к интернету при загрузке. В файл /etc/rc.local вставляем до строки exit 0</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>route del default dev eth1
</span><span class='line'>route del default dev eth2
</span><span class='line'>route add -net 10.0.0.0 netmask 255.0.0.0 gw 10.0.4.254 eth0
</span><span class='line'>pon tvoynet</span></code></pre></td></tr></table></div></figure>


<p>Перезагружаем сервер для проверки: shutdown -r now. Должен появиться интерфейс ppp0. Как обычно проверяем наличие интернета пингом до ya.ru</p>

<p>Интернет есть, теперь обновляемся.</p>

<p>Запускаем aptitude. Нажимаем U (это эквивалентно aptitude update) для обновления списка пакетов. Если будут обновления, полявиться раздел: Upgradable Packages (n). Выбираем этот раздел и нажимаем +(плюс). Далее нажимаем g, выведуться все пакеты для обновления, удаления, установки. Можно отменить обновление какого-либо пакета, выбрав его и нажав :(двоеточие). И снова нажимаем g для обновления.</p>

<p>Нужно установить сервер dhcp для раздачи автоматических настроек для домашних компьютеров, а также DNS-сервер bind9.</p>

<p>В aptitude нажимаем .(точка в английской раскладке, левее правого шифта) – это вызовет поиск. Вводим dhcp3 и нажимаем n до тех пор, пока не найдём пакет dhcp3-server, нажимаем +(плюс). Далее опять вызываем поиск, вводим ^bind9$ (^ – означает начало строки, $ – конец строки), т.е. мы ищем по полному совпадению, ставим и его.</p>

<p>Настраиваем DHCP.</p>

<p>Файл /etc/dhcp3/dhcpd.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ddns-update-style none;
</span><span class='line'>default-lease-time 31536000;
</span><span class='line'>max-lease-time 31536000;
</span><span class='line'>authoritative;
</span><span class='line'>log-facility local7;
</span><span class='line'>
</span><span class='line'>subnet 192.168.1.0 netmask 255.255.255.0 {
</span><span class='line'>   option domain-name "";
</span><span class='line'>   option domain-name-servers 192.168.1.254;
</span><span class='line'>   option routers 192.168.1.254;
</span><span class='line'>   range 192.168.1.50 192.168.1.150;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>subnet 192.168.2.0 netmask 255.255.255.0 {
</span><span class='line'>   option domain-name "";
</span><span class='line'>   option domain-name-servers 192.168.2.254;
</span><span class='line'>   option routers 192.168.2.254;
</span><span class='line'>   range 192.168.2.50 192.168.2.150;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>subnet 192.168.3.0 netmask 255.255.255.0 {
</span><span class='line'>   option domain-name "";
</span><span class='line'>   option domain-name-servers 192.168.3.254;
</span><span class='line'>   option routers 192.168.3.254;
</span><span class='line'>   range 192.168.3.50 192.168.3.150;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>host stamm-desktop {
</span><span class='line'>   hardware ethernet 00:1a:1d:9f:46:91;
</span><span class='line'>   fixed-address 192.168.1.1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Последний абзац означает привязку ip адреса 192.168.1.1 к mac-адресу 00:1a:1d:9f:46:91 для хоста stamm-desktop. Аналогично добавляем для других домашних компьютеров. Чтобы узнать mac адрес других компьютеров в сети, наберите arp.</p>

<p>Меняем файл /etc/default/dhcp3-server для установки прослушивающих интерфейсов для DHCP сервера</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INTERFACES="eth1 eth2 wlan0"</span></code></pre></td></tr></table></div></figure>


<p>Рестартуем dhcp сервер:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>invoke-rc.d dhcp3-server restart</span></code></pre></td></tr></table></div></figure>


<p>Теперь очередь за bind9 /etc/bind/named.conf.options</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>options {
</span><span class='line'>   directory "/var/cache/bind";
</span><span class='line'>
</span><span class='line'>   forwarders {
</span><span class='line'>       10.0.0.1;
</span><span class='line'>       10.0.0.10;
</span><span class='line'>   };
</span><span class='line'>
</span><span class='line'>   auth-nxdomain no;    # conform to RFC1035
</span><span class='line'>   listen-on-v6 { none; };
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>Этим мы просто форвардим запросы на другие dns-сервера. В данном случае 10.0.0.1 и 10.0.0.10</p>

<p>Рестартуем bind9:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>invoke-rc.d bind9 restart</span></code></pre></td></tr></table></div></figure>


<p>Теперь убираем ручные настройки на компьютере, должен присвоиться адрес 192.168.1.1. Теперь можно подключить второй компьютер.</p>

<p>Есть несколько инструкций по настройке wi-fi карты dlink DWA-520, например, Ubuntu 9.04 По команде</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lspci -v</span></code></pre></td></tr></table></div></figure>


<p>Выдаёт информацию по карте:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>01:06.0 Ethernet controller: Atheros Communications Inc. Atheros AR5001X+ Wireless Network Adapter (rev 01)
</span><span class='line'>Subsystem: D-Link System Inc Device 3a73
</span><span class='line'>Flags: bus master, medium devsel, latency 168, IRQ 16
</span><span class='line'>Memory at e4000000 (32-bit, non-prefetchable) [size=64K]
</span><span class='line'>Capabilities: [44] Power Management version 2
</span><span class='line'>Kernel driver in use: ath5k</span></code></pre></td></tr></table></div></figure>


<p>Устанавливаем hostapd</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aptitude install hostapd</span></code></pre></td></tr></table></div></figure>


<p>Редактируем файл /etc/hostapd/hostapd.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>interface=wlan0
</span><span class='line'>driver=nl80211
</span><span class='line'>#Названии точки доступа
</span><span class='line'>ssid=Server1
</span><span class='line'>hw_mode=g
</span><span class='line'>channel=2
</span><span class='line'>
</span><span class='line'>macaddr_acl=0
</span><span class='line'>
</span><span class='line'>auth_algs=1
</span><span class='line'>ignore_broadcast_ssid=0
</span><span class='line'>
</span><span class='line'>wpa=2
</span><span class='line'>wpa_key_mgmt=WPA-PSK
</span><span class='line'>wpa_passphrase=SuperParol
</span><span class='line'>wpa_pairwise=TKIP
</span><span class='line'>rsn_pairwise=TKIP</span></code></pre></td></tr></table></div></figure>


<p>Редактируем файл /etc/default/hostapd</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RUN_DAEMON="yes"
</span><span class='line'>DAEMON_CONF="/etc/hostapd/hostapd.conf"</span></code></pre></td></tr></table></div></figure>


<p>Пока без NAT компьютеры не могут выходить в интернет. Читайте в следующей статье. Учтите, ваш сервер доступен из-вне. На него можно законектиься по ssh через интернет – будьте осторожны. Нужно настроить фаервол. В следующей статье мы как раз этим и займёмся.</p>

<p><a href="/debian-1-install">← Часть 1</a> | <a href="/debian-3-setting-iptables-forward-nat-firewall">Часть 3 →</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/debian-1-install/">Debian. Часть 1: установка</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-28T00:36:00+04:00" pubdate data-updated="true">2010-07-28</time>
        
         | <a href="/debian-1-install/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Есть цель написать статьи по настройке домашнего сервера для различных нужд:</p>

<ul>
<li>шлюз для выхода всех компьютеров в квартире в интернет через vpn (pptp) + wi-fi</li>
<li>веб-сервер</li>
<li>торрент-качалка + samba</li>
<li>эксперименты</li>
</ul>


<p>Схема сети такая:</p>

<p><img src="/images/debian-1-install//schema.png" alt="Схема сети" /></p>

<p>Эти статьи будут и как напоминающая инструкция самому себе.</p>

<p>Начну с самого начала: установка системы GNU/Linux.</p>

<h2>Лирическое отступление:</h2>

<p>Есть довольного много серверных дистрибутивов: Debian, Ubuntu, Gentoo, Arch, Slackware, etch. Можно много холиварить на эти темы. Мой выбор Debian был обусловлен несколькими факторами:</p>

<p>Человек, который мне порекомендовал посмотреть Linux, пользовался Debian и это оставило свой след: я мог спросить о непонятных вещах и получить быстрый толковый ответ. На мой взгляд, ОС должна быть простой и понятной Люблю пакетные дистрибутивы Почему не Ubuntu, спросите вы? Знакомые linux-админы ставили ubuntu LTS: 6.06 и 8.04 на боевые сервера. По их словам 6.06 был отличным, но 8.04 стал очень медленным. Поставленный Debian на тот же сервак летал по сравнению с Ubuntu 8.04. Сам на домашнем компьютере использую Ubuntu, Debian уж слижком чопорный для десктопа. Но в качестве серверного дистрибутива однозначно Debian.</p>

<p>Другие дистрибутивы пробывал, но они жили в моей виртуалке не больше суток. Каждый выбирает свой дистрибутив, но я покажу установку, а в следующих постах и базовую настройку Debian 5.0.5 с апгрейдом до sid. Вопреки стериотипам, Sid (он же unstable) работает довольно стабильно. За всё время его использования не возникало проблем. Плюс в репозитариях присутствуют свежие пакеты программ.</p>

<h2>Итак, поехали.</h2>

<p><a href="http://www.debian.org/CD/torrent-cd/">Скачиваем последний дистрибутив Debian</a>. Если у вас 64 битный процессор, то лучше скачать amd64, если 32 битный, то i386. В процессе своей работы столкнулся с такой проблемой: на 32-битной системе функция intval работала только с числами от -2147483648 до 2147483647. Решение данной проблемы было найдено только на 2-ой день на php.net.</p>

<blockquote><p>The maximum value depends on the system. 32 bit systems have a maximum signed integer range of -2147483648 to 2147483647. So for example on such a system, intval(’1000000000000′) will return 2147483647. The maximum signed integer value for 64 bit systems is 92233720368547758007<br/>Ставлю Debian на старый компьютер (Athlon 1700, 512 Mb Ram, 40+160 Gb HDD) В моём случае Debian 5.0.5 i386.</p></blockquote>


<p>Установка тривиально, в интернете <a href="http://www.mixali4.org.ru/2009/08/shljuz-na-debian-s-shahmatami-i_23.html">полно статей</a> по этому поводу со скриншотами. Несколько замечаний от меня: ставить только английский язык и устанавливать только базовую систему.</p>

<p><a href="/debian-2-setting-network-dhcp-bind9-vpn">Часть 2 →</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/5/">&larr; Старее</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/3/">Новее &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/macos-update-mysql2-mysql-5-dot-6/">Обновление Gem Mysql2 на MacOS X при обновлении MySQL до 5.6</a>
      </li>
    
      <li class="post">
        <a href="/how-to-install-ruby-2-dot-0-0-p0/">Как установить Ruby 2.0.0-p0</a>
      </li>
    
      <li class="post">
        <a href="/links-parade-2/">Парад ссылок №2</a>
      </li>
    
      <li class="post">
        <a href="/links-parade-1/">Парад ссылок №1</a>
      </li>
    
      <li class="post">
        <a href="/gnu-grep-faster-than-mac-os-x/">Ускорение скорости работы Grep в Mac OS X</a>
      </li>
    
  </ul>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Загиров Рустам -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zagirov';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
